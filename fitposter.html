<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FitPoster - å¥èº«å£çº¸ç”Ÿæˆå™¨</title>
    
    <!-- Tailwind CSS (æ ·å¼åº“) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#00D4FF',
              secondary: '#FF0055',
              dark: '#0F172A',
              card: '#1E293B',
            },
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
          },
        },
      }
    </script>
    
    <!-- React & ReactDOM (æ ¸å¿ƒæ¡†æ¶) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (è®©æµè§ˆå™¨èƒ½è¿è¡Œ React ä»£ç ) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
      body {
        font-family: 'Inter', sans-serif;
        background-color: #0F172A;
        color: white;
      }
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: #0F172A; }
      ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #475569; }
      
      /* Animation Utilities */
      .fade-in { animation: fadeIn 0.5s ease-in; }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

      /* Loading å’Œé”™è¯¯æç¤ºæ ·å¼ */
      #resource-loader-overlay {
        position: fixed;
        inset: 0;
        background-color: #0F172A;
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: opacity 0.3s ease;
      }
      
      #resource-loader-overlay.hidden {
        opacity: 0;
        pointer-events: none;
      }
      
      .loader-content {
        text-align: center;
      }
      
      .pulse-container {
        display: flex;
        gap: 12px;
        justify-content: center;
        margin-bottom: 24px;
      }
      
      .pulse-dot {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: linear-gradient(135deg, #00D4FF, #FF0055);
        animation: pulse 1.4s ease-in-out infinite;
      }
      
      .pulse-dot:nth-child(2) {
        animation-delay: 0.2s;
      }
      
      .pulse-dot:nth-child(3) {
        animation-delay: 0.4s;
      }
      
      @keyframes pulse {
        0%, 100% {
          transform: scale(0.8);
          opacity: 0.5;
        }
        50% {
          transform: scale(1.2);
          opacity: 1;
        }
      }
      
      .error-panel {
        background: #1E293B;
        border: 2px solid #EF4444;
        border-radius: 16px;
        padding: 32px;
        max-width: 600px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      }
      
      .error-icon {
        width: 64px;
        height: 64px;
        margin: 0 auto 20px;
        background: #FEE2E2;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
      }
      
      .error-title {
        color: #EF4444;
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 16px;
      }
      
      .error-list {
        background: #0F172A;
        border-radius: 8px;
        padding: 16px;
        margin: 20px 0;
        text-align: left;
      }
      
      .error-item {
        color: #F87171;
        font-size: 14px;
        margin: 8px 0;
        padding-left: 24px;
        position: relative;
      }
      
      .error-item:before {
        content: "âœ—";
        position: absolute;
        left: 0;
        color: #EF4444;
        font-weight: bold;
      }
      
      .error-hint {
        color: #94A3B8;
        font-size: 14px;
        margin: 16px 0;
        line-height: 1.6;
      }
      
      .error-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
        margin-top: 24px;
      }
      
      .btn-retry, .btn-help {
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        font-size: 14px;
      }
      
      .btn-retry {
        background: #00D4FF;
        color: #0F172A;
      }
      
      .btn-retry:hover {
        background: #22D3EE;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 212, 255, 0.4);
      }
      
      .btn-help {
        background: transparent;
        color: #94A3B8;
        border: 2px solid #334155;
      }
      
      .btn-help:hover {
        color: #E2E8F0;
        border-color: #475569;
      }
      
      .help-section {
        display: none;
        background: #0F172A;
        border-radius: 8px;
        padding: 16px;
        margin-top: 16px;
        text-align: left;
      }
      
      .help-section.show {
        display: block;
        animation: fadeIn 0.3s ease;
      }
      
      .help-section h4 {
        color: #00D4FF;
        font-size: 14px;
        font-weight: bold;
        margin-bottom: 12px;
      }
      
      .help-section ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      
      .help-section li {
        color: #94A3B8;
        font-size: 13px;
        margin: 8px 0;
        padding-left: 20px;
        position: relative;
      }
      
      .help-section li:before {
        content: "â€¢";
        position: absolute;
        left: 0;
        color: #00D4FF;
      }
      
      .retry-warning {
        display: none;
        background: #451A03;
        border: 1px solid #F59E0B;
        border-radius: 8px;
        padding: 12px;
        margin-top: 16px;
        color: #FCD34D;
        font-size: 13px;
        line-height: 1.5;
      }
      
      .retry-warning.show {
        display: block;
        animation: fadeIn 0.3s ease;
      }
    </style>
</head>
<body>
    <!-- èµ„æºåŠ è½½çŠ¶æ€è¦†ç›–å±‚ -->
    <div id="resource-loader-overlay">
        <div class="loader-content">
            <!-- Loading çŠ¶æ€ -->
            <div id="loading-state">
                <div class="pulse-container">
                    <div class="pulse-dot"></div>
                    <div class="pulse-dot"></div>
                    <div class="pulse-dot"></div>
                </div>
                <p style="color: #94A3B8; font-size: 16px; font-weight: 500;">æ­£åœ¨åŠ è½½èµ„æº...</p>
            </div>
            
            <!-- é”™è¯¯çŠ¶æ€ -->
            <div id="error-state" style="display: none;">
                <div class="error-panel">
                    <div class="error-icon">âš ï¸</div>
                    <div class="error-title">èµ„æºåŠ è½½å¤±è´¥</div>
                    
                    <div class="error-list" id="error-details">
                        <!-- åŠ¨æ€æ’å…¥å¤±è´¥é¡¹ -->
                    </div>
                    
                    <div class="error-hint">
                        è¿™é€šå¸¸æ˜¯ç”±äºç½‘ç»œé—®é¢˜æˆ– CDN è®¿é—®å—é™å¯¼è‡´çš„ã€‚<br>
                        è¯·ç‚¹å‡»"é‡è¯•"æŒ‰é’®åˆ·æ–°é¡µé¢ï¼Œæˆ–æŸ¥çœ‹ä¸‹æ–¹å¸®åŠ©ä¿¡æ¯ã€‚
                    </div>
                    
                    <!-- å¤šæ¬¡é‡è¯•è­¦å‘Š -->
                    <div class="retry-warning" id="retry-warning">
                        âš ï¸ æ£€æµ‹åˆ°å¤šæ¬¡é‡è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥çŠ¶æ€ï¼Œæˆ–å°è¯•ï¼š<br>
                        â€¢ åˆ‡æ¢åˆ°å…¶ä»–ç½‘ç»œï¼ˆå¦‚æ‰‹æœºçƒ­ç‚¹ï¼‰<br>
                        â€¢ æ£€æŸ¥é˜²ç«å¢™æˆ–ä»£ç†è®¾ç½®<br>
                        â€¢ ç¨åå†è¯•
                    </div>
                    
                    <div class="error-actions">
                        <button class="btn-retry" onclick="handleRetry()">ğŸ”„ é‡è¯•</button>
                        <button class="btn-help" onclick="toggleHelp()">â“ æŸ¥çœ‹å¸®åŠ©</button>
                    </div>
                    
                    <!-- å¸®åŠ©ä¿¡æ¯ -->
                    <div class="help-section" id="help-section">
                        <h4>æ•…éšœæ’æŸ¥æŒ‡å¼•</h4>
                        <ul>
                            <li>ç¡®è®¤æ‚¨çš„è®¾å¤‡å·²è¿æ¥åˆ°äº’è”ç½‘</li>
                            <li>å°è¯•è®¿é—®å…¶ä»–ç½‘ç«™ï¼Œç¡®è®¤ç½‘ç»œè¿é€šæ€§</li>
                            <li>æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†å¹¿å‘Šæ‹¦æˆªæˆ–éšç§ä¿æŠ¤æ’ä»¶ï¼ˆå¯èƒ½é˜»æ­¢ CDN èµ„æºï¼‰</li>
                            <li>å¦‚æœåœ¨å…¬å¸æˆ–å­¦æ ¡ç½‘ç»œï¼Œå¯èƒ½å­˜åœ¨é˜²ç«å¢™é™åˆ¶</li>
                            <li>å°è¯•ä½¿ç”¨å…¶ä»–æµè§ˆå™¨ï¼ˆChrome/Edge/Firefoxï¼‰</li>
                            <li>æ¸…é™¤æµè§ˆå™¨ç¼“å­˜åé‡è¯•</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="root"></div>

    <!-- æ ¸å¿ƒåº”ç”¨ä»£ç  -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 1. å›¾æ ‡ç»„ä»¶ (SVG Paths) ---
        const ICONS = {
            Dumbbell: <path d="M6.5 6.5l11 11M21 21l-1-1a2.828 2.828 0 0 1 0-4l1-1m-17 6l1-1a2.828 2.828 0 0 0 0-4l-1-1m17-10l-4.5 4.5M3 3l1 1a2.828 2.828 0 0 0 4 0l1-1m-6 5l4.5-4.5m1 11l4-4" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" fill="none"/>,
            PlusCircle: <g fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 8v8M8 12h8"/></g>,
            Flame: <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.5-3.3.3-1.1.9-2.07 1.8-2.2.2.14.3.4.2.7z" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
            Clock: <g fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></g>,
            Download: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
            Upload: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
            Save: <g fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></g>,
            Sparkles: <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
            RefreshCw: <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8M21 3v5h-5M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16M3 21v-5h5" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
            BarChart3: <path d="M3 3v18h18M18 17V9M13 17V5M8 17v-3" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
            Palette: <path d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5-5 4 4 0 0 1-5-5m-6.5 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0m2.5 4a1 1 0 1 1-2 0 1 1 0 0 1 2 0m3 4a1 1 0 1 1-2 0 1 1 0 0 1 2 0" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
            Activity: <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
            Database: <g fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></g>,
            PieChart: <g fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></g>,
            LineChart: <g fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"/><path d="M18 9l-5 5-4-4-6 6"/></g>,
            Image: <rect x="3" y="3" width="18" height="18" rx="2" ry="2" stroke="currentColor" strokeWidth="2" fill="none" strokeLinecap="round" strokeLinejoin="round"></rect>,
            ImagePlus: <g fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7"/><line x1="16" y1="5" x2="22" y2="5"/><line x1="19" y1="2" x2="19" y2="8"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></g>,
            Trash2: <g fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></g>,
            MapPin: <g fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></g>,
            Crop: <g fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 2v14a2 2 0 0 0 2 2h14"/><path d="M18 22V8a2 2 0 0 0-2-2H2"/></g>,
            GripVertical: <g fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></g>
        };

        // å›¾è¡¨æ¨¡å¼ä¸æ•°æ®ç»´åº¦
        const ChartMode = {
            CURVE: 'Curve',    // æ›²çº¿
            LINE: 'Line',      // æŠ˜çº¿
            BAR: 'Bar'         // æŸ±çŠ¶
        };

        const DataMetric = {
            DURATION: 'Duration', // æ—¶é•¿
            CALORIES: 'Calories', // çƒ­é‡
            STEPS: 'Steps',       // æ­¥æ•°
            DISTANCE: 'Distance', // è·ç¦»
            PACE: 'Pace'          // é…é€Ÿ (min/km)
        };

        const Icon = ({ name, size = 20, className = "" }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                className={className}
            >
                {ICONS[name] || null}
            </svg>
        );

        /**
         * ä» workout å¯¹è±¡ä¸­æå–æ ‡å‡†åŒ–çš„æ—¥æœŸå¯¹è±¡
         * æ”¯æŒä» date å­—æ®µæˆ– id å­—æ®µï¼ˆæ ¼å¼ï¼šYYYY-MM-DD-Nï¼‰è§£æ
         * @param {Object} workout - è¿åŠ¨è®°å½•å¯¹è±¡
         * @returns {Date} æ—¥æœŸå¯¹è±¡ï¼Œè§£æå¤±è´¥æ—¶è¿”å› 1970-01-01
         */
        const getWorkoutDate = (workout) => {
            // ä¼˜å…ˆä½¿ç”¨ date å­—æ®µ
            if (workout.date) {
                const d = new Date(workout.date);
                if (!isNaN(d.getTime())) return d;
            }
            // ä» id è§£æï¼ˆæ ¼å¼ï¼šYYYY-MM-DD-N æˆ– YYYY-M-D-Nï¼‰
            if (workout.id && typeof workout.id === 'string') {
                const parts = workout.id.split('-');
                if (parts.length >= 3) {
                    const d = new Date(`${parts[0]}-${parts[1]}-${parts[2]}`);
                    if (!isNaN(d.getTime())) return d;
                }
            }
            return new Date(0); // å…œåº•ï¼šè¿”å›æœ€æ—©æ—¥æœŸ
        };

        /**
         * ç»Ÿä¸€çš„æ—¥æœŸæ’åºæ¯”è¾ƒå™¨
         * @param {Object} a - è¿åŠ¨è®°å½•å¯¹è±¡ A
         * @param {Object} b - è¿åŠ¨è®°å½•å¯¹è±¡ B
         * @returns {number} æ’åºç»“æœï¼ˆè´Ÿæ•°/0/æ­£æ•°ï¼‰
         */
        const sortByDate = (a, b) => getWorkoutDate(a) - getWorkoutDate(b);

        /**
         * è®¡ç®—è·ç¦»æœ€åä¸€æ¬¡è¿åŠ¨çš„å¤©æ•°
         * @param {Array} typeData - è¿åŠ¨è®°å½•æ•°ç»„
         * @returns {number} å¤©æ•°å·®è·ï¼Œå¦‚æœæ— æ•°æ®è¿”å› 0
         */
        const calculateDaysSinceLastWorkout = (typeData) => {
            if (!typeData || typeData.length === 0) return 0;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const latestWorkout = typeData[typeData.length - 1]; // å‡è®¾å·²æ’åº
            const workoutDate = getWorkoutDate(latestWorkout);
            workoutDate.setHours(0, 0, 0, 0);
            
            return Math.floor((today - workoutDate) / (1000 * 60 * 60 * 24));
        };

        /**
         * è·å–è¿åŠ¨ä¸­æ–­æé†’é…ç½®
         * @param {number} daysSince - è·ç¦»æœ€åä¸€æ¬¡è¿åŠ¨çš„å¤©æ•°
         * @param {string} sportType - è¿åŠ¨ç±»å‹ï¼ˆå¦‚ "Running" æˆ– "DailySummary"ï¼‰
         * @param {number} recordCount - å†å²è®°å½•æ•°é‡
         * @returns {Object|null} è¿”å› { text, color, emoji } æˆ– nullï¼ˆä¸æ˜¾ç¤ºæé†’ï¼‰
         */
        const getReminderConfig = (daysSince, sportType, recordCount) => {
            // ä¸æ»¡è¶³æé†’æ¡ä»¶ï¼šè®°å½•æ•° < 2 æˆ– å¤©æ•° â‰¤ 3
            if (recordCount < 2 || daysSince <= 3) return null;
            
            // ç¡®å®šé¢œè‰²å’Œå›¾æ ‡
            let color, emoji;
            if (daysSince >= 8) {
                color = '#EF4444'; // çº¢è‰²
                emoji = 'ğŸ”¥';
            } else if (daysSince >= 6) {
                color = '#FB923C'; // æ©™è‰²
                emoji = 'âš ï¸';
            } else {
                color = '#FBBF24'; // é»„è‰²
                emoji = 'ğŸ’ª';
            }
            
            // ç¡®å®šè¿åŠ¨ç±»å‹æ–‡æ¡ˆ
            const activityName = sportType === 'DailySummary' ? 'è¿åŠ¨' : sportType;
            
            return {
                text: `ä½ å·²ç» ${daysSince} å¤©æ²¡æœ‰${activityName}å•¦ ${emoji}`,
                color,
                emoji
            };
        };

        // --- 2. æœåŠ¡é€»è¾‘ (æœ¬åœ°æ•°æ®ç”Ÿæˆ) ---
        const QUOTES = {
            high_calorie: ["èƒ½é‡çˆ†æ£šï¼", "ç‡ƒçƒ§å§ï¼Œå¡è·¯é‡Œï¼", "æé™çªç ´", "çº¯ç²¹çš„åŠ›é‡", "é‡æ–°å®šä¹‰æé™"],
            consistency: ["åšæŒå°±æ˜¯èƒœåˆ©", "åˆèµ¢äº†ä¸€å¤©", "ç§¯å°‘æˆå¤š", "è¿›æ­¥èƒœè¿‡å®Œç¾", "è‡ªå¾‹å³è‡ªç”±"],
            generic: ["æ•°æ®å¯è§†åŒ–ä½ çš„åŠªåŠ›", "è®©æ±—æ°´å˜æˆè‰ºæœ¯", "ä¸“æ³¨ç›®æ ‡", "è¿åŠ¨å³ç”Ÿå‘½", "æ¯ä¸€æ­¥éƒ½ç®—æ•°"]
        };

        const PosterStyle = {
            NATURE: 'Zen Nature'
        };

        const generatePosterInsight = (workouts) => {
            const totalCals = workouts.reduce((sum, w) => sum + w.calories, 0);
            let pool = QUOTES.generic;
            if (totalCals > 2000) pool = [...pool, ...QUOTES.high_calorie];
            if (workouts.length > 5) pool = [...pool, ...QUOTES.consistency];
            
            const randomQuote = pool[Math.floor(Math.random() * pool.length)];
            return randomQuote;
        };

        // --- 3. åŸºç¡€ç»„ä»¶ ---
        const Button = ({ children, variant = 'primary', className = '', onClick, ...props }) => {
            const base = "px-4 py-2 rounded-lg font-semibold transition-all duration-200 flex items-center justify-center gap-2 active:scale-95 disabled:opacity-50";
            const variants = {
                primary: "bg-primary text-dark hover:bg-cyan-400 shadow-lg shadow-cyan-500/30",
                secondary: "bg-secondary text-white hover:bg-rose-600 shadow-lg shadow-rose-500/30",
                outline: "border-2 border-slate-600 text-slate-300 hover:border-primary hover:text-primary bg-transparent",
                ghost: "bg-transparent text-slate-400 hover:text-white hover:bg-slate-800"
            };
            return (
                <button onClick={onClick} className={`${base} ${variants[variant]} ${className}`} {...props}>
                    {children}
                </button>
            );
        };

        // --- 4. ä¸šåŠ¡ç»„ä»¶ ---
        // å¢åŠ  workouts å±æ€§æ¥æ”¶ï¼Œç”¨äºè®¡ç®— ID åºå·
        const WorkoutForm = ({ onAddWorkout, workouts }) => {
            const [type, setType] = useState('');
            const [duration, setDuration] = useState('');
            const [calories, setCalories] = useState('');
            const [num, setNum] = useState(''); // æ­¥æ•°è¾“å…¥
            const [notes, setNotes] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!type) return;

                const today = new Date().toISOString().split('T')[0];
                
                // è®¡ç®—å½“å¤©åºå· (ID æ ¼å¼: YYYY-MM-DD-N)
                const count = workouts.filter(w => w.date === today).length + 1;
                const newId = `${today}-${count}`;

                const newWorkout = {
                    id: newId,
                    type: type.trim(), 
                    duration: parseInt(duration) || 0,
                    calories: parseInt(calories) || 0,
                    num: parseInt(num) || 0, // ä¿å­˜æ­¥æ•°
                    date: today,
                    notes
                };
                onAddWorkout(newWorkout);
                setType(''); setDuration(''); setCalories(''); setNum(''); setNotes('');
            };

            return (
                <div className="bg-card p-6 rounded-2xl shadow-xl border border-slate-800">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold text-white flex items-center gap-2">
                            <Icon name="PlusCircle" className="text-primary" /> Log Workout
                        </h2>
                    </div>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-slate-400 mb-1">Exercise Type</label>
                            <div className="relative">
                                <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"><Icon name="Dumbbell" size={16} /></div>
                                <input type="text" value={type} onChange={(e) => setType(e.target.value)} placeholder="e.g. æ¯æ—¥è¡Œèµ°æ­¥æ•°, Running" className="w-full bg-dark border border-slate-700 rounded-lg py-2 pl-10 pr-4 text-white focus:outline-none focus:border-primary transition-colors" required />
                            </div>
                        </div>
                        <div className="grid grid-cols-3 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-400 mb-1">Duration</label>
                                <div className="relative">
                                    <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"><Icon name="Clock" size={16} /></div>
                                    <input type="number" value={duration} onChange={(e) => setDuration(e.target.value)} placeholder="min" className="w-full bg-dark border border-slate-700 rounded-lg py-2 pl-10 pr-4 text-white focus:outline-none focus:border-primary transition-colors" />
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-400 mb-1">Calories</label>
                                <div className="relative">
                                    <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"><Icon name="Flame" size={16} /></div>
                                    <input type="number" value={calories} onChange={(e) => setCalories(e.target.value)} placeholder="kcal" className="w-full bg-dark border border-slate-700 rounded-lg py-2 pl-10 pr-4 text-white focus:outline-none focus:border-primary transition-colors" />
                                </div>
                            </div>
                            {/* æ­¥æ•°è¾“å…¥æ¡† */}
                            <div>
                                <label className="block text-sm font-medium text-slate-400 mb-1">Steps</label>
                                <div className="relative">
                                    <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"><Icon name="Activity" size={16} /></div>
                                    <input type="number" value={num} onChange={(e) => setNum(e.target.value)} placeholder="num" className="w-full bg-dark border border-slate-700 rounded-lg py-2 pl-10 pr-4 text-white focus:outline-none focus:border-primary transition-colors" />
                                </div>
                            </div>
                        </div>
                        <Button type="submit" className="w-full">Save Entry</Button>
                    </form>
                </div>
            );
        };

        // --- ç»„ä»¶:JSON ç¼–è¾‘å™¨ (å«æ–‡ä»¶å¯¼å…¥/å¯¼å‡ºåŠŸèƒ½) ---
        const JsonEditor = ({ workouts, onUpdate }) => {
            const [jsonText, setJsonText] = useState(JSON.stringify(workouts, null, 2));
            const [error, setError] = useState(null);
            const fileInputRef = useRef(null);
            
            // ç”¨äºå­˜å‚¨æ–‡ä»¶å¤¹å¥æŸ„å’Œé™çº§æç¤ºçŠ¶æ€
            const directoryHandleRef = useRef(null);
            const fallbackWarningShownRef = useRef(false);

            // åŒæ­¥æ•°æ®
            useEffect(() => {
                setJsonText(JSON.stringify(workouts, null, 2));
            }, [workouts]);

            // ä¿å­˜åˆ° App çŠ¶æ€ (åº”ç”¨æ›´æ”¹)
            const handleApply = () => {
                try {
                    const parsed = JSON.parse(jsonText);
                    if (!Array.isArray(parsed)) throw new Error("æ•°æ®æ ¼å¼é”™è¯¯ï¼šæ ¹èŠ‚ç‚¹å¿…é¡»æ˜¯æ•°ç»„ [...]");
                    onUpdate(parsed);
                    setError(null);
                    alert("æ•°æ®å·²æ›´æ–°åˆ°å½“å‰è§†å›¾ï¼");
                } catch (err) {
                    setError(err.message);
                }
            };

            // å¯¼å‡º JSON æ–‡ä»¶ - ä½¿ç”¨æ–°çš„ä¿å­˜å·¥å…·å‡½æ•°
            const handleExport = async () => {
                try {
                    // éªŒè¯ JSON æ ¼å¼
                    JSON.parse(jsonText);
                    
                    // ä½¿ç”¨æ–°çš„æ–‡ä»¶ä¿å­˜å·¥å…·
                    await saveFileWithDialog(
                        jsonText,
                        'metadata.json',
                        'application/json',
                        directoryHandleRef,
                        fallbackWarningShownRef
                    );
                } catch (err) {
                    setError("å¯¼å‡ºå¤±è´¥ï¼šå½“å‰ç¼–è¾‘å™¨å†…å®¹çš„ JSON æ ¼å¼ä¸æ­£ç¡®");
                }
            };

            // å¯¼å…¥ JSON æ–‡ä»¶
            const handleFileImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const content = e.target.result;
                        const parsed = JSON.parse(content);
                        if (!Array.isArray(parsed)) throw new Error("æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼šJSON å†…å®¹å¿…é¡»æ˜¯æ•°ç»„ [...]");
                        
                        onUpdate(parsed);
                        setJsonText(JSON.stringify(parsed, null, 2));
                        setError(null);
                        alert(`æˆåŠŸå¯¼å…¥ ${parsed.length} æ¡è®°å½•ï¼`);
                    } catch (err) {
                        setError("å¯¼å…¥å¤±è´¥: " + err.message);
                        alert("å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶ã€‚");
                    }
                    event.target.value = '';
                };
                reader.readAsText(file);
            };

            return (
                <div className="bg-card p-6 rounded-2xl shadow-xl border border-slate-800 h-full flex flex-col">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold text-white flex items-center gap-2">
                            <Icon name="Database" className="text-primary" /> JSON Data
                        </h2>
                        
                        <div className="flex gap-2">
                            <input type="file" ref={fileInputRef} onChange={handleFileImport} className="hidden" accept=".json" />
                            
                            {/* å¯¼å…¥æŒ‰é’® */}
                            <Button onClick={() => fileInputRef.current.click()} variant="outline" className="text-xs px-3 py-1" title="Import JSON">
                                <Icon name="Upload" size={14} /> å¯¼å…¥
                            </Button>

                            {/* å¯¼å‡ºæŒ‰é’® - æ–‡æœ¬ä»"å¤‡ä»½"æ”¹ä¸º"å¯¼å‡º" */}
                            <Button onClick={handleExport} variant="outline" className="text-xs px-3 py-1" title="Export JSON">
                                <Icon name="Save" size={14} /> å¯¼å‡º
                            </Button>

                            {/* åº”ç”¨æ›´æ”¹æŒ‰é’® */}
                            <Button onClick={handleApply} size="sm" className="text-xs px-3 py-1" title="Apply changes to view">
                                åº”ç”¨
                            </Button>
                        </div>
                    </div>
                    
                    {error && <div className="mb-2 text-red-400 text-xs bg-red-900/20 p-2 rounded">{error}</div>}
                    
                    <textarea
                        className="flex-1 w-full bg-dark border border-slate-700 rounded-lg p-4 text-xs font-mono text-slate-300 focus:outline-none focus:border-primary resize-none leading-relaxed custom-scrollbar"
                        value={jsonText}
                        onChange={(e) => setJsonText(e.target.value)}
                        spellCheck="false"
                        placeholder="æ•°æ®å°†æ˜¾ç¤ºåœ¨è¿™é‡Œã€‚æ‚¨å¯ä»¥å¯¼å…¥ .json æ–‡ä»¶ï¼Œæˆ–æ‰‹åŠ¨ç¼–è¾‘åç‚¹å‡»'åº”ç”¨'ã€‚"
                    />
                    <p className="text-slate-500 text-xs mt-2">æ¨èå®šæœŸç‚¹å‡»"å¯¼å‡º"æŒ‰é’®ï¼Œå°†æ•°æ®ä¿å­˜ä¸º .json æ–‡ä»¶åˆ°æœ¬åœ°ã€‚</p>
                </div>
            );
        };

        /**
         * ç»„ä»¶ï¼šæ ‡è¯­ç®¡ç†é¢æ¿
         * æä¾›å¤šè¡Œæ–‡æœ¬ç¼–è¾‘ã€çº¦å®šæ ¼å¼æ ¡éªŒï¼ˆ- å¼€å¤´ï¼‰ã€å¯¼å…¥å¯¼å‡ºåŠŸèƒ½
         */
        const SloganManager = ({ slogans, onUpdate }) => {
            const fileInputRef = useRef(null);
            
            // ç”¨äºå­˜å‚¨æ–‡ä»¶å¤¹å¥æŸ„å’Œé™çº§æç¤ºçŠ¶æ€
            const directoryHandleRef = useRef(null);
            const fallbackWarningShownRef = useRef(false);

            // å¯¼å‡ºæ ‡è¯­ä¸ºæ–‡æœ¬æ–‡ä»¶ - ä½¿ç”¨æ–°çš„ä¿å­˜å·¥å…·å‡½æ•°
            const handleExport = async () => {
                await saveFileWithDialog(
                    slogans,
                    'slogans.txt',
                    'text/plain',
                    directoryHandleRef,
                    fallbackWarningShownRef
                );
            };

            // ä»æ–‡æœ¬æ–‡ä»¶å¯¼å…¥æ ‡è¯­
            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const content = evt.target.result;
                    onUpdate(content);
                    alert("æ ‡è¯­å¯¼å…¥æˆåŠŸï¼");
                };
                reader.readAsText(file);
                e.target.value = '';
            };

            return (
                <div className="bg-card p-6 rounded-2xl shadow-xl border border-slate-800 h-full flex flex-col">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold text-white flex items-center gap-2">
                            <Icon name="Sparkles" className="text-primary" /> åŠ±å¿—æ ‡è¯­ç®¡ç†
                        </h2>
                        <div className="flex gap-2">
                            <input type="file" ref={fileInputRef} onChange={handleImport} className="hidden" accept=".txt" />
                            <Button onClick={() => fileInputRef.current.click()} variant="outline" className="text-xs px-3 py-1">
                                <Icon name="Upload" size={14} /> å¯¼å…¥
                            </Button>
                            <Button onClick={handleExport} variant="outline" className="text-xs px-3 py-1">
                                <Icon name="Save" size={14} /> å¯¼å‡º
                            </Button>
                        </div>
                    </div>
                    
                    <textarea
                        className="flex-1 w-full bg-dark border border-slate-700 rounded-lg p-4 text-sm font-mono text-slate-300 focus:outline-none focus:border-primary resize-none leading-relaxed custom-scrollbar min-h-[200px]"
                        value={slogans}
                        onChange={(e) => onUpdate(e.target.value)}
                        spellCheck="false"
                        placeholder="- åšæŒå°±æ˜¯èƒœåˆ©&#10;- æ¯ä¸€æ»´æ±—æ°´éƒ½æ˜¯æˆåŠŸçš„åŸºçŸ³..."
                    />
                    <div className="mt-2 space-y-1">
                        <p className="text-slate-500 text-[11px]">çº¦å®šï¼šæ¯è¡Œä¸€æ¡ï¼Œå¿…é¡»ä»¥ "- " (æ¨ªæ +ç©ºæ ¼) å¼€å¤´ã€‚</p>
                        <p className="text-primary/70 text-[11px]">ç³»ç»Ÿå°†å®æ—¶è‡ªåŠ¨ä¿å­˜æ‚¨çš„æ›´æ”¹ã€‚</p>
                    </div>
                </div>
            );
        };

        // ç»„ä»¶ï¼šè¿·ä½ å›¾è¡¨é¢„è§ˆ (æ”¯æŒä¼ å…¥ color å±æ€§ä»¥ä¿æŒä¸€è‡´æ€§)
        const MiniChartPreview = ({ data, mode, metric, color: overrideColor, sportType }) => {
            const canvasRef = useRef(null);

            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas || !data || data.length === 0) return;

                const ctx = canvas.getContext('2d');
                const dpr = window.devicePixelRatio || 1;
                
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width * dpr;
                canvas.height = rect.height * dpr;
                ctx.scale(dpr, dpr);

                const W = rect.width;
                const H = rect.height;
                const padding = 10;
                const drawW = W - padding * 2;
                const drawH = H - padding * 2;

                ctx.clearRect(0, 0, W, H);

                // ä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„ overrideColorï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤é€»è¾‘
                let drawColor = overrideColor;
                if (!drawColor) {
                    drawColor = '#00D4FF';
                    if (metric === DataMetric.CALORIES) drawColor = '#FF0055';
                    if (metric === DataMetric.STEPS) drawColor = '#10B981'; 
                    if (metric === DataMetric.DISTANCE) drawColor = '#A855F7';
                    if (metric === DataMetric.PACE) drawColor = '#F59E0B';
                }
                
                // å‡†å¤‡æ•°æ®
                let values = [];
                if (metric === DataMetric.PACE) {
                    values = data.map(d => {
                        const dist = d.distance || 0;
                        const dur = d.duration || 0;
                        return dist > 0 ? (dur / dist) : 0;
                    });
                } else {
                    let metricKey = 'duration';
                    if (metric === DataMetric.CALORIES) metricKey = 'calories';
                    if (metric === DataMetric.STEPS) metricKey = 'num';
                    if (metric === DataMetric.DISTANCE) metricKey = 'distance';
                    values = data.map(d => d[metricKey] || 0);
                }

                const maxVal = Math.max(...values, 1) * 1.1;
                
                // ç»˜åˆ¶çºµåæ ‡è½´
                // Yè½´çº¿
                ctx.strokeStyle = 'rgba(255,255,255,0.15)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(padding, padding);
                ctx.lineTo(padding, H - padding);
                ctx.stroke();

                // Yè½´åˆ»åº¦å’Œæ ‡ç­¾ï¼ˆ3ä¸ªåˆ»åº¦ç‚¹ï¼š0%, 50%, 100%ï¼‰
                ctx.fillStyle = 'rgba(255,255,255,0.4)';
                ctx.font = '9px Inter';
                ctx.textAlign = 'right';
                ctx.textBaseline = 'middle';

                const yTicks = [0, 0.5, 1]; // å¯¹åº” 0%, 50%, 100%
                yTicks.forEach(ratio => {
                    const y = H - padding - (ratio * drawH);
                    const value = Math.round(maxVal * ratio);
                    
                    // åˆ»åº¦çº¿
                    ctx.strokeStyle = 'rgba(255,255,255,0.1)';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(padding, y);
                    ctx.lineTo(padding + 3, y);
                    ctx.stroke();
                    
                    // æ•°å€¼æ ‡ç­¾
                    ctx.fillText(value.toString(), padding - 4, y);
                });

                ctx.strokeStyle = drawColor;
                ctx.fillStyle = drawColor;
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';

                const stepX = drawW / (values.length - 1 || 1);

                if (mode === ChartMode.BAR) {
                    const barWidth = (drawW / values.length) * 0.6;
                    values.forEach((val, i) => {
                        const h = (val / maxVal) * drawH;
                        const x = padding + (i * (drawW / values.length)) + (drawW / values.length - barWidth) / 2;
                        const y = H - padding - h;
                        ctx.beginPath();
                        if (ctx.roundRect) ctx.roundRect(x, y, barWidth, h, [4, 4, 0, 0]);
                        else ctx.rect(x, y, barWidth, h);
                        ctx.fill();
                    });
                } else {
                    ctx.beginPath();
                    if (values.length === 1) {
                        const val = values[0];
                        const y = H - padding - ((val / maxVal) * drawH);
                        ctx.moveTo(padding, y); ctx.lineTo(W - padding, y);
                    } else {
                        values.forEach((val, i) => {
                            const x = padding + i * stepX;
                            const y = H - padding - ((val / maxVal) * drawH);
                            if (i === 0) ctx.moveTo(x, y);
                            else {
                                if (mode === ChartMode.CURVE) {
                                    const prevVal = values[i - 1];
                                    const prevX = padding + (i - 1) * stepX;
                                    const prevY = H - padding - ((prevVal / maxVal) * drawH);
                                    const midX = (prevX + x) / 2;
                                    ctx.bezierCurveTo(midX, prevY, midX, y, x, y);
                                } else { ctx.lineTo(x, y); }
                            }
                        });
                    }
                    ctx.shadowColor = drawColor; ctx.shadowBlur = 10; ctx.stroke(); ctx.shadowBlur = 0;
                    ctx.fillStyle = '#1E293B'; ctx.lineWidth = 2;
                    values.forEach((val, i) => {
                        const x = padding + i * stepX;
                        const y = H - padding - ((val / maxVal) * drawH);
                        ctx.beginPath(); ctx.arc(x, y, 3, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
                    });
                }
            }, [data, mode, metric, overrideColor]);

            // è®¡ç®—æé†’ä¿¡æ¯
            const daysSince = calculateDaysSinceLastWorkout(data);
            const reminderConfig = getReminderConfig(daysSince, sportType || 'preview', data?.length || 0);
            
            return (
                <div className="relative">
                    <canvas ref={canvasRef} className="w-full h-32 rounded-lg bg-dark/50 border border-slate-700/50" />
                    {reminderConfig && (
                        <div 
                            className="text-center text-xs mt-1.5 font-medium"
                            style={{ color: reminderConfig.color }}
                        >
                            {reminderConfig.text}
                        </div>
                    )}
                </div>
            );
        };

        // DataOverviewPanelï¼šå¢åŠ ç›®æ ‡æ—¥æœŸè¾“å…¥
        const DataOverviewPanel = ({ workouts, goals, onGoalsChange }) => {
            const stats = {
                count: workouts.length,
                totalDuration: workouts.reduce((sum, w) => sum + (w.duration || 0), 0),
                totalCalories: workouts.reduce((sum, w) => sum + (w.calories || 0), 0),
                totalSteps: workouts.reduce((sum, w) => sum + (w.num || 0), 0),
                totalDistance: workouts.reduce((sum, w) => sum + (w.distance || 0), 0).toFixed(2),
                avgDuration: workouts.length ? Math.round(workouts.reduce((sum, w) => sum + (w.duration || 0), 0) / workouts.length) : 0
            };

            return (
                <div className="bg-card p-6 rounded-2xl shadow-xl border border-slate-800 h-full">
                    <h2 className="text-xl font-bold text-white flex items-center gap-2 mb-6">
                        <Icon name="Activity" className="text-primary" /> æ•°æ®æ¦‚è§ˆ
                    </h2>

                    <div className="mb-6 p-4 bg-dark/30 rounded-xl border border-dashed border-slate-700 space-y-3">
                        <div>
                            <label className="block text-[10px] uppercase font-bold text-slate-500 mb-1">ä¸€çº§å¤§ç›®æ ‡ (Major Goal)</label>
                            <input 
                                type="text" 
                                value={goals?.title || ""} 
                                onChange={(e) => onGoalsChange({...goals, title: e.target.value})}
                                className="w-full bg-dark border border-slate-600 rounded px-3 py-1.5 text-white font-bold focus:border-primary focus:outline-none transition-colors"
                                placeholder="ä¾‹å¦‚ï¼š2025 å¥èº«è®¡åˆ’"
                            />
                        </div>
                        <div>
                            <label className="block text-[10px] uppercase font-bold text-slate-500 mb-1">äºŒçº§å°ç›®æ ‡ (Subtitle)</label>
                            <input 
                                type="text" 
                                value={goals?.subtitle || ""} 
                                onChange={(e) => onGoalsChange({...goals, subtitle: e.target.value})}
                                className="w-full bg-dark border border-slate-600 rounded px-3 py-1.5 text-sm text-slate-300 focus:border-primary focus:outline-none transition-colors"
                                placeholder="ä¾‹å¦‚ï¼šè‡ªå¾‹å³è‡ªç”±"
                            />
                        </div>
                        {/* å€’è®¡æ—¶æ—¥æœŸè¾“å…¥ */}
                        <div>
                            <label className="block text-[10px] uppercase font-bold text-slate-500 mb-1">ç›®æ ‡å€’è®¡æ—¶æ—¥æœŸ (Target Date)</label>
                            <div className="relative">
                                <input 
                                    type="date" 
                                    value={goals?.targetDate || ""} 
                                    onChange={(e) => onGoalsChange({...goals, targetDate: e.target.value})}
                                    className="w-full bg-dark border border-slate-600 rounded px-3 py-1.5 text-sm text-white focus:border-primary focus:outline-none transition-colors"
                                />
                                <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-500">
                                    <Icon name="Clock" size={14} />
                                </div>
                            </div>
                            <p className="text-[10px] text-slate-500 mt-1">è®¾ç½®åå°†åœ¨å£çº¸ä¸Šæ˜¾ç¤ºå€’è®¡æ—¶å¤©æ•°ã€‚</p>
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        <div className="bg-dark/50 p-4 rounded-xl border border-slate-700">
                            <div className="text-slate-400 text-xs mb-1">ç´¯è®¡è¿åŠ¨</div>
                            <div className="text-2xl font-bold text-white">{stats.count} <span className="text-sm font-normal text-slate-500">æ¬¡</span></div>
                        </div>
                        <div className="bg-dark/50 p-4 rounded-xl border border-slate-700">
                            <div className="text-slate-400 text-xs mb-1">ç´¯è®¡æ—¶é•¿</div>
                            <div className="text-2xl font-bold text-primary">{stats.totalDuration} <span className="text-sm font-normal text-slate-500">min</span></div>
                        </div>
                        <div className="bg-dark/50 p-4 rounded-xl border border-slate-700">
                            <div className="text-slate-400 text-xs mb-1">æ¶ˆè€—çƒ­é‡</div>
                            <div className="text-2xl font-bold text-secondary">{stats.totalCalories.toLocaleString()} <span className="text-sm font-normal text-slate-500">kcal</span></div>
                        </div>
                        <div className="bg-dark/50 p-4 rounded-xl border border-slate-700">
                            <div className="text-slate-400 text-xs mb-1">ç´¯è®¡è·‘é‡</div>
                            <div className="text-2xl font-bold text-purple-400">{stats.totalDistance} <span className="text-sm font-normal text-slate-500">km</span></div>
                        </div>
                        <div className="bg-dark/50 p-4 rounded-xl border border-slate-700">
                            <div className="text-slate-400 text-xs mb-1">ç´¯è®¡æ­¥æ•°</div>
                            <div className="text-2xl font-bold text-emerald-400">{stats.totalSteps.toLocaleString()} <span className="text-sm font-normal text-slate-500">steps</span></div>
                        </div>
                        <div className="bg-dark/50 p-4 rounded-xl border border-slate-700">
                            <div className="text-slate-400 text-xs mb-1">å¹³å‡æ—¶é•¿</div>
                            <div className="text-2xl font-bold text-white">{stats.avgDuration} <span className="text-sm font-normal text-slate-500">min</span></div>
                        </div>
                    </div>
                </div>
            );
        };

        const VisualConfigPanel = ({ workouts, sportConfigs, onConfigChange, visualSettings, chartDataDays, onChartDataDaysChange }) => {
            const [dragInfo, setDragInfo] = useState({ type: null, sourceRow: null });
            const [dropTarget, setDropTarget] = useState({ row: null, index: null });

            const SPECIAL_TYPE_ID = 'DailySummary';
            const rawUniqueTypes = [...new Set(workouts.map(w => w.type))].filter(t => t !== 'Swimming' && t !== 'æ¸¸æ³³').sort();
            const allTypes = (workouts.length > 0) ? [SPECIAL_TYPE_ID, ...rawUniqueTypes] : [];

            // æ ¹æ®å½“å‰é…ç½®å°†ç±»å‹åˆ†é…åˆ°ä¸¤è¡Œ
            const getRowsData = () => {
                const rows = { 1: [], 2: [] };
                allTypes.forEach(type => {
                    const config = sportConfigs[type] || {};
                    const r = config.row === 2 ? 2 : 1;
                    rows[r].push({ type, col: config.col || 99 });
                });
                rows[1].sort((a, b) => a.col - b.col);
                rows[2].sort((a, b) => a.col - b.col);
                return rows;
            };

            const rowsData = getRowsData();

            // æ ¸å¿ƒï¼šå¤„ç†æ’ç‰ˆæ›´æ–°é€»è¾‘ï¼ˆåŸå­åŒ–æ›´æ–°ï¼Œè§£å†³è·³å›Bugï¼‰
            const finalizeReorder = (type, targetRow, targetIndex) => {
                const newRows = { 1: rowsData[1].map(d => d.type), 2: rowsData[2].map(d => d.type) };
                
                // ä»åŸä½ç½®ç§»é™¤
                newRows[1] = newRows[1].filter(t => t !== type);
                newRows[2] = newRows[2].filter(t => t !== type);
                
                // æ’å…¥æ–°ä½ç½®
                newRows[targetRow].splice(targetIndex, 0, type);

                // é‡æ–°è®¡ç®—æ‰€æœ‰å—å½±å“ç±»å‹çš„ row å’Œ col
                const updatedConfigs = { ...sportConfigs };
                [1, 2].forEach(r => {
                    newRows[r].forEach((t, idx) => {
                        updatedConfigs[t] = { 
                            ...(updatedConfigs[t] || { mode: 'Curve', metric: 'Duration' }), 
                            row: r, 
                            col: idx + 1 
                        };
                    });
                });
                
                onConfigChange(updatedConfigs);
                setDragInfo({ type: null, sourceRow: null });
                setDropTarget({ row: null, index: null });
            };

            const handleDragStart = (type, sourceRow) => {
                setDragInfo({ type, sourceRow });
            };

            const handleDragOver = (e, row, index) => {
                e.preventDefault();
                // ç¦æ­¢è½å…¥é€»è¾‘ï¼šè¡Œæ»¡3ä¸ªä¸”ä¸æ˜¯æ¥è‡ªæœ¬è¡Œ
                if (rowsData[row].length >= 3 && dragInfo.sourceRow !== row) {
                    return;
                }
                setDropTarget({ row, index });
            };

            const updateSingleConfig = (type, key, value) => {
                onConfigChange({
                    ...sportConfigs,
                    [type]: { ...(sportConfigs[type] || { mode: 'Curve', metric: 'Duration', row: 1, col: 1 }), [key]: value }
                });
            };

            return (
                <div className="bg-card p-6 rounded-2xl shadow-xl border border-slate-800 w-full">
                    <h2 className="text-xl font-bold text-white flex items-center gap-2 mb-6">
                        <Icon name="Palette" className="text-secondary" /> å¸ƒå±€ä¸è§†è§‰é…ç½®
                    </h2>

                    {/* å…¨å±€å¤©æ•°è®¾ç½® */}
                    <div className="mb-8 p-4 bg-primary/5 border border-primary/20 rounded-xl flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <Icon name="BarChart3" className="text-primary" />
                            <span className="text-sm font-bold">å›¾è¡¨å±•ç¤ºå¤©æ•°</span>
                        </div>
                        <input type="number" value={chartDataDays} onChange={(e) => onChartDataDaysChange(parseInt(e.target.value))} className="w-20 bg-dark border border-slate-600 rounded px-2 py-1 text-center" />
                    </div>

                    {/* æ‹–æ‹½è¡Œå®¹å™¨ */}
                    <div className="space-y-12">
                        {[1, 2].forEach && [1, 2].map(rowNum => (
                            <div key={rowNum} className="relative">
                                <div className="absolute -top-6 left-0 text-[10px] font-bold text-slate-500 uppercase tracking-widest">ROW {rowNum} (æœ€å¤š3ä¸ª)</div>
                                <div 
                                    onDragOver={(e) => handleDragOver(e, rowNum, rowsData[rowNum].length)}
                                    onDrop={() => dropTarget.row && finalizeReorder(dragInfo.type, dropTarget.row, dropTarget.index)}
                                    className={`min-h-[220px] p-4 rounded-2xl border-2 border-dashed transition-all flex flex-wrap justify-center gap-6 ${dropTarget.row === rowNum ? 'border-primary bg-primary/5' : 'border-slate-800 bg-dark/20'}`}
                                >
                                    {rowsData[rowNum].map((item, idx) => (
                                        <React.Fragment key={item.type}>
                                            {/* å®æ—¶å ä½ç¬¦ */}
                                            {dropTarget.row === rowNum && dropTarget.index === idx && dragInfo.type !== item.type && (
                                                <div className="w-72 h-48 border-2 border-dashed border-primary/30 rounded-2xl bg-primary/5 animate-pulse" />
                                            )}
                                            
                                            <div 
                                                draggable="false"
                                                onDragOver={(e) => { e.stopPropagation(); handleDragOver(e, rowNum, idx); }}
                                                className={`w-72 bg-dark/60 border border-slate-700 p-4 rounded-2xl relative group ${dragInfo.type === item.type ? 'opacity-40 scale-95' : 'opacity-100'}`}
                                            >
                                                {/* æ‹–æ‹½æ‰‹æŸ„ */}
                                                <div 
                                                    draggable 
                                                    onDragStart={() => handleDragStart(item.type, rowNum)}
                                                    className="absolute top-4 left-4 cursor-grab active:cursor-grabbing p-1 text-slate-500 hover:text-white transition-colors"
                                                >
                                                    <Icon name="GripVertical" size={18} />
                                                </div>

                                                <div className="text-center mb-4 mt-1 font-bold text-sm text-slate-300">
                                                    {item.type === SPECIAL_TYPE_ID ? "æ¯æ—¥è¿åŠ¨ç»Ÿè®¡" : item.type}
                                                </div>

                                                <div className="space-y-3">
                                                    {/* é¢œè‰² */}
                                                    <div className="flex gap-2 items-center">
                                                        <input type="color" value={sportConfigs[item.type]?.customColor || '#4ade80'} onChange={(e) => updateSingleConfig(item.type, 'customColor', e.target.value)} className="w-8 h-8 rounded bg-transparent cursor-pointer" />
                                                        <div className="flex-1 bg-dark/50 px-2 py-1 rounded text-[10px] font-mono text-slate-400">
                                                            {sportConfigs[item.type]?.customColor || 'é»˜è®¤é¢œè‰²'}
                                                        </div>
                                                    </div>
                                                    {/* ç±»å‹ä¸æŒ‡æ ‡ç®€é€‰ */}
                                                    <div className="grid grid-cols-2 gap-2">
                                                        <select value={sportConfigs[item.type]?.mode || 'Curve'} onChange={(e) => updateSingleConfig(item.type, 'mode', e.target.value)} className="bg-dark border border-slate-700 rounded px-1 py-1 text-[10px] text-slate-300">
                                                            <option value="Curve">æ›²çº¿</option><option value="Line">æŠ˜çº¿</option><option value="Bar">æŸ±çŠ¶</option>
                                                        </select>
                                                        <select value={sportConfigs[item.type]?.metric || 'Duration'} onChange={(e) => updateSingleConfig(item.type, 'metric', e.target.value)} className="bg-dark border border-slate-700 rounded px-1 py-1 text-[10px] text-slate-300">
                                                            <option value="Duration">æ—¶é•¿</option><option value="Calories">çƒ­é‡</option><option value="Steps">æ­¥æ•°</option><option value="Distance">è·ç¦»</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </React.Fragment>
                                    ))}
                                    {/* å°¾éƒ¨å ä½ç¬¦ */}
                                    {dropTarget.row === rowNum && dropTarget.index === rowsData[rowNum].length && (
                                        <div className="w-72 h-48 border-2 border-dashed border-primary/30 rounded-2xl bg-primary/5 animate-pulse" />
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };


        const WorkoutHistory = ({ workouts, onSelect, selectedId }) => {
            if (workouts.length === 0) return <div className="text-center py-10 text-slate-500"><p>No workouts recorded yet.</p></div>;
            
            // æ·»åŠ æ’åºé€»è¾‘
            const sortedWorkouts = [...workouts].sort(sortByDate);
            
            return (
                <div className="space-y-3">
                    {sortedWorkouts.map((w) => (
                        <div key={w.id} onClick={() => onSelect(w)} className={`p-4 rounded-xl border cursor-pointer transition-all hover:translate-x-1 ${selectedId === w.id ? 'bg-slate-800 border-primary' : 'bg-dark border-slate-800 hover:border-slate-600'}`}>
                            <div className="flex justify-between items-start mb-2">
                                <h3 className="font-bold text-white">{w.type}</h3>
                                <span className="text-xs text-slate-400 bg-slate-900 px-2 py-1 rounded">{new Date(w.date).toLocaleDateString()}</span>
                            </div>
                            <div className="flex gap-4 text-xs text-slate-400">
                                <div className="flex items-center gap-1"><Icon name="Clock" size={12} /> {w.duration}m</div>
                                <div className="flex items-center gap-1"><Icon name="Flame" size={12} /> {w.calories} kcal</div>
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        /**
         * è£å‰ªç»„ä»¶ï¼šæä¾› 16:9 æ¯”ä¾‹çš„åŠé€æ˜è£å‰ªæ¡†
         * æ”¯æŒåœ¨å›¾ç‰‡èŒƒå›´å†…ç§»åŠ¨è£å‰ªæ¡†
         */
        const ImageCropModal = ({ src, onConfirm, onCancel }) => {
            const [imgMeta, setImgMeta] = useState({ width: 0, height: 0, displayWidth: 0, displayHeight: 0 });
            const [crop, setCrop] = useState({ x: 0, y: 0, width: 0, height: 0 }); // è¿™é‡Œçš„æ•°å€¼æ˜¯åŸºäºæ˜¾ç¤ºå°ºå¯¸çš„ px
            const containerRef = useRef(null);
            const isDragging = useRef(false);
            const startPos = useRef({ x: 0, y: 0 });

            const ASPECT_RATIO = 3840 / 2160; // 16:9

            const handleImageLoad = (e) => {
                const { naturalWidth, naturalHeight, clientWidth, clientHeight } = e.target;
                setImgMeta({ width: naturalWidth, height: naturalHeight, displayWidth: clientWidth, displayHeight: clientHeight });
                
                // åˆå§‹åŒ–è£å‰ªæ¡†ï¼šè®¡ç®—æœ€å¤§å¯èƒ½çš„ 16:9 åŒºåŸŸ
                let cw, ch;
                if (clientWidth / clientHeight > ASPECT_RATIO) {
                    ch = clientHeight;
                    cw = ch * ASPECT_RATIO;
                } else {
                    cw = clientWidth;
                    ch = cw / ASPECT_RATIO;
                }
                setCrop({ x: (clientWidth - cw) / 2, y: (clientHeight - ch) / 2, width: cw, height: ch });
            };

            const handleMouseDown = (e) => {
                isDragging.current = true;
                startPos.current = { x: e.clientX - crop.x, y: e.clientY - crop.y };
            };

            const handleMouseMove = (e) => {
                if (!isDragging.current) return;
                let nx = e.clientX - startPos.current.x;
                let ny = e.clientY - startPos.current.y;

                // è¾¹ç•Œæ£€æŸ¥
                nx = Math.max(0, Math.min(nx, imgMeta.displayWidth - crop.width));
                ny = Math.max(0, Math.min(ny, imgMeta.displayHeight - crop.height));

                setCrop(prev => ({ ...prev, x: nx, y: ny }));
            };

            const handleMouseUp = () => { isDragging.current = false; };

            const handleConfirm = () => {
                // å°†æ˜¾ç¤ºå°ºå¯¸çš„åæ ‡è½¬æ¢ä¸ºåŸå§‹å›¾ç‰‡çš„åƒç´ åæ ‡
                const scale = imgMeta.width / imgMeta.displayWidth;
                onConfirm({
                    x: crop.x * scale,
                    y: crop.y * scale,
                    width: crop.width * scale,
                    height: crop.height * scale
                });
            };

            return (
                <div className="fixed inset-0 z-[100] bg-black/90 flex items-center justify-center p-4" onMouseMove={handleMouseMove} onMouseUp={handleMouseUp}>
                    <div className="bg-card max-w-4xl w-full rounded-2xl overflow-hidden shadow-2xl flex flex-col max-h-[90vh]">
                        <div className="p-4 border-b border-slate-800 flex justify-between items-center">
                            <h3 className="text-lg font-bold">è°ƒæ•´èƒŒæ™¯æˆªå–åŒºåŸŸ</h3>
                            <div className="flex gap-2">
                                <Button variant="ghost" onClick={onCancel}>å–æ¶ˆ</Button>
                                <Button onClick={handleConfirm}>åº”ç”¨è£å‰ª</Button>
                            </div>
                        </div>
                        <div className="flex-1 bg-dark relative overflow-hidden flex items-center justify-center p-8 select-none" ref={containerRef}>
                            <div className="relative inline-block">
                                <img 
                                    src={src} 
                                    onLoad={handleImageLoad} 
                                    className="max-w-full max-h-[60vh] object-contain pointer-events-none shadow-lg" 
                                    draggable="false"
                                />
                                {/* åŠé€æ˜é®ç½©å±‚ - ä½¿ç”¨ SVG ç»˜åˆ¶ç©ºæ´æ•ˆæœ */}
                                <div className="absolute inset-0 pointer-events-none overflow-hidden">
                                    <div className="absolute inset-0 bg-black/60"></div>
                                    <div 
                                        className="absolute border-2 border-primary shadow-[0_0_0_9999px_rgba(0,0,0,0.6)] cursor-move pointer-events-auto flex items-center justify-center"
                                        style={{ left: crop.x, top: crop.y, width: crop.width, height: crop.height }}
                                        onMouseDown={handleMouseDown}
                                    >
                                        <div className="text-[10px] text-primary font-bold bg-dark/80 px-1 rounded">16:9 å£çº¸åŒºåŸŸ</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div className="p-4 bg-slate-900 text-slate-400 text-xs text-center">
                            æç¤ºï¼šæ‹–åŠ¨é«˜äº®åŒºåŸŸé€‰æ‹©æ‚¨å¸Œæœ›åœ¨å£çº¸èƒŒæ™¯ä¸­æ˜¾ç¤ºçš„å›¾ç‰‡éƒ¨åˆ†ã€‚
                        </div>
                    </div>
                </div>
            );
        };

        const PosterGenerator = ({ workouts, goals, visualSettings, sportConfigs, onVisualSettingsChange, slogans, chartDataDays }) => {
            // è§£ææ ‡è¯­åº“
            const getSloganPool = () => {
                const pool = slogans.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.startsWith('- '))
                    .map(line => line.substring(2).trim())
                    .filter(line => line.length > 0);
                return pool.length > 0 ? pool : ["ä¸“æ³¨ç›®æ ‡ï¼Œæ¯ä¸€æ­¥éƒ½ç®—æ•°"];
            };

            const [insight, setInsight] = useState(() => {
                const pool = getSloganPool();
                return pool[Math.floor(Math.random() * pool.length)];
            });

            const [userImage, setUserImage] = useState(null); 
            const [isCropModalOpen, setIsCropModalOpen] = useState(false);
            const { style, imageSize = 300, imageShape = 'circle', bgOpacity = 0.15 } = visualSettings;
            
            const canvasRef = useRef(null);
            const fileInputRef = useRef(null); 

            useEffect(() => {
                const savedImage = localStorage.getItem('fitposter_user_image');
                if (savedImage) setUserImage(savedImage);
            }, []);

            useEffect(() => {
                if (userImage) {
                    try { localStorage.setItem('fitposter_user_image', userImage); } 
                    catch (e) { console.warn("å›¾ç‰‡å¤ªå¤§ï¼Œæ— æ³•ä¿å­˜", e); }
                } else { localStorage.removeItem('fitposter_user_image'); }
            }, [userImage]);

            const stats = {
                totalWorkouts: workouts.length,
                totalCalories: workouts.reduce((acc, curr) => acc + (curr.calories || 0), 0),
                totalDuration: workouts.reduce((acc, curr) => acc + (curr.duration || 0), 0),
                totalSteps: workouts.reduce((acc, curr) => acc + (curr.num || 0), 0),
                totalDistance: workouts.reduce((acc, curr) => acc + (curr.distance || 0), 0).toFixed(1), 
            };

            // åˆ·æ–°æ—¶éšæœºæŠ½å–æ ‡è¯­
            const handleRefresh = () => {
                const pool = getSloganPool();
                setInsight(pool[Math.floor(Math.random() * pool.length)]);
            };

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        setUserImage(evt.target.result);
                        onVisualSettingsChange({ ...visualSettings, bgCrop: null });
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleCropConfirm = (cropParams) => {
                onVisualSettingsChange({ ...visualSettings, bgCrop: cropParams });
                setIsCropModalOpen(false);
            };

            useEffect(() => {
                if (!canvasRef.current || workouts.length === 0) return;
                
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                canvas.width = 3840; canvas.height = 2160;
                const W = canvas.width; const H = canvas.height;

                // è®¡ç®—æœ¬å‘¨ä¸€çš„æ—¥æœŸå­—ç¬¦ä¸²
                const renderFrame = (imgObj) => {
                    ctx.clearRect(0, 0, W, H);

                    // è®¡ç®—å¹¶æ ‡å‡†åŒ–æœ¬å‘¨ä¸€æ—¥æœŸå¯¹è±¡
                    const now = new Date();
                    const day = now.getDay(); // 0 (Sun) to 6 (Sat)
                    // è®¡ç®—æœ¬å‘¨ä¸€ã€‚å¦‚æœæ˜¯å‘¨æ—¥(0)ï¼Œå‡å»6å¤©ï¼›å¦åˆ™å‡å» (day-1) å¤©
                    const mondayDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - (day === 0 ? 6 : day - 1));
                    mondayDate.setHours(0, 0, 0, 0); // å…³é”®ï¼šæ—¶é—´å½’é›¶ä»¥æ”¯æŒæ—¥æœŸæ¯”è¾ƒ

                    if (visualSettings.useImageAsBackground && imgObj) {
                        ctx.save();
                        ctx.fillStyle = '#0F172A'; ctx.fillRect(0, 0, W, H);
                        ctx.filter = `blur(${visualSettings.bgBlur ?? 60}px)`;

                        if (visualSettings.bgCrop) {
                            const { x, y, width, height } = visualSettings.bgCrop;
                            ctx.drawImage(imgObj, x, y, width, height, 0, 0, W, H);
                        } else {
                            const imgRatio = imgObj.width / imgObj.height;
                            const canvasRatio = W / H;
                            let drawW, drawH, drawX, drawY;
                            if (imgRatio > canvasRatio) {
                                drawH = H; drawW = H * imgRatio; drawY = 0; drawX = (W - drawW) / 2;
                            } else {
                                drawW = W; drawH = W / imgRatio; drawX = 0; drawY = (H - drawH) / 2;
                            }
                            const scale = 1.1;
                            ctx.drawImage(imgObj, drawX - (drawW*(scale-1))/2, drawY - (drawH*(scale-1))/2, drawW * scale, drawH * scale);
                        }
                        ctx.restore();
                        ctx.fillStyle = `rgba(15, 23, 42, 0.8)`; 
                        ctx.fillRect(0, 0, W, H);
                    } else {
                        const grad = ctx.createLinearGradient(0, 0, 0, H);
                        grad.addColorStop(0, '#022c22'); 
                        grad.addColorStop(1, '#064e3b');
                        ctx.fillStyle = grad; 
                        ctx.fillRect(0, 0, W, H);
                        for(let i=0; i<20; i++) {
                            ctx.beginPath(); 
                            ctx.arc(Math.random() * W, Math.random() * H, Math.random() * 300 + 50, 0, Math.PI*2);
                            ctx.fillStyle = `rgba(34, 197, 94, ${Math.random() * 0.1})`; 
                            ctx.fill();
                        }
                        const g = ctx.createLinearGradient(0, 0, 0, H);
                        g.addColorStop(0, "rgba(15, 23, 42, 0.2)"); g.addColorStop(1, "rgba(15, 23, 42, 0.9)");
                        ctx.fillStyle = g; ctx.fillRect(0, 0, W, H);
                    }

                    let mainColor = '#4ade80'; let secColor = '#facc15'; let textColor = 'rgba(255,255,255,0.8)';

                    const statsOriginX = 300;
                    const statsOriginY = 160;
                    const colGap = 400; 
                    const rowGap = 160; 

                    ctx.textAlign = "left";
                    const drawGridStat = (label, val, col, row) => {
                        const x = statsOriginX + col * colGap;
                        const y = statsOriginY + row * rowGap;
                        ctx.font = "bold 28px Inter"; 
                        ctx.fillStyle = "rgba(255,255,255,0.4)"; 
                        ctx.fillText(label, x, y);
                        ctx.font = "bold 70px Inter"; 
                        ctx.fillStyle = "#ffffff"; 
                        ctx.fillText(val, x, y + 70);
                    };

                    drawGridStat("æ€»è¿åŠ¨æ¬¡æ•°", `${stats.totalWorkouts}`, 0, 0);
                    drawGridStat("æ€»æ­¥æ•°", `${stats.totalSteps.toLocaleString()}`, 1, 0);
                    drawGridStat("è·‘æ­¥é‡Œç¨‹ (km)", `${stats.totalDistance}`, 0, 1);
                    drawGridStat("è¿åŠ¨æ—¶é•¿ (min)", `${stats.totalDuration}`, 1, 1);

                    ctx.textAlign = "center";
                    const centerX = W / 2 + 100; 
                    ctx.font = "bold 70px Inter"; 
                    ctx.fillStyle = "#ffffff";
                    ctx.textAlign = "center";
                    ctx.textBaseline = "alphabetic";
                    ctx.fillText(goals?.title || "", centerX, 180);

                    const subRowY = 280;    
                    const subGap = 30;      
                    let subRowWidth = 0;
                    let bLabel = "";
                    let bW = 0;
                    const subTitleStr = goals?.subtitle || "";

                    if (goals?.targetDate) {
                        const diff = Math.ceil((new Date(goals.targetDate) - new Date()) / (1000 * 60 * 60 * 24));
                        if (!isNaN(diff)) {
                            bLabel = diff >= 0 ? `${diff} DAYS LEFT` : `${Math.abs(diff)} DAYS SINCE`;
                            ctx.font = "bold 30px Inter";
                            bW = ctx.measureText(bLabel).width + 40;
                            subRowWidth += bW;
                        }
                    }

                    let sW = 0;
                    if (subTitleStr) {
                        ctx.font = "500 50px Inter";
                        sW = ctx.measureText(subTitleStr).width;
                        subRowWidth += (subRowWidth > 0 ? subGap : 0) + sW;
                    }

                    let drawX = centerX - subRowWidth / 2;

                    if (bLabel) {
                        const bH = 50;
                        const bRectY = subRowY - bH / 2;
                        ctx.beginPath();
                        ctx.roundRect(drawX, bRectY, bW, bH, 25);
                        ctx.fillStyle = 'rgba(255,255,255,0.1)';
                        ctx.fill();
                        ctx.strokeStyle = mainColor;
                        ctx.lineWidth = 2;
                        ctx.stroke();
                        ctx.fillStyle = mainColor;
                        ctx.font = "bold 30px Inter";
                        ctx.textAlign = "center";
                        ctx.textBaseline = "middle";
                        ctx.fillText(bLabel, drawX + bW / 2, subRowY + 2);
                        drawX += bW + subGap;
                    }

                    if (subTitleStr) {
                        ctx.font = "500 50px Inter";
                        ctx.fillStyle = textColor;
                        ctx.textAlign = "left";
                        ctx.textBaseline = "middle";
                        ctx.fillText(subTitleStr, drawX, subRowY);
                    }

                    if (insight) {
                        ctx.font = "italic 400 40px Inter"; 
                        ctx.fillStyle = "rgba(255,255,255,0.7)";
                        ctx.textAlign = "center";
                        ctx.textBaseline = "alphabetic";
                        ctx.fillText(`â€œ ${insight} â€`, centerX, 400); 
                    }

                    ctx.textAlign = "center";
                    ctx.textBaseline = "alphabetic";

                    if (imgObj) {
                        const size = imageSize; 
                        const margin = 120;
                        const x = W - size - margin;
                        const y = margin;
                        ctx.save();
                        ctx.shadowColor = "rgba(0,0,0,0.3)"; ctx.shadowBlur = 20; ctx.shadowOffsetY = 10;
                        if (imageShape === 'circle') {
                            ctx.beginPath(); ctx.arc(x + size/2, y + size/2, size/2, 0, Math.PI * 2); ctx.closePath(); ctx.clip();
                            ctx.drawImage(imgObj, x, y, size, size);
                            ctx.restore(); 
                            ctx.beginPath(); ctx.arc(x + size/2, y + size/2, size/2, 0, Math.PI * 2);
                            ctx.lineWidth = 4; ctx.strokeStyle = '#fff'; ctx.stroke();
                        } else {
                            const aspectRatio = imgObj.width / imgObj.height;
                            const drawW = size; const drawH = size / aspectRatio;
                            ctx.drawImage(imgObj, x, y, drawW, drawH);
                            ctx.restore(); 
                            ctx.lineWidth = 4; ctx.strokeStyle = '#fff'; ctx.strokeRect(x, y, drawW, drawH);
                        }
                    }

                    const chartAreaTop = 560; const chartAreaBottom = 2060;
                    const chartTotalHeight = chartAreaBottom - chartAreaTop;
                    const GRID_ROWS = 2; const maxColsInLayout = 3; const sideMargin = 150;
                    const gapX = 150; const gapY = 100;
                    const cellWidth = (W - sideMargin * 2 - (gapX * (maxColsInLayout - 1))) / maxColsInLayout;
                    const cellHeight = (chartTotalHeight - (gapY * (GRID_ROWS - 1))) / GRID_ROWS;

                    const workoutsByType = {};
                    workouts.forEach(w => {
                        if (!workoutsByType[w.type]) workoutsByType[w.type] = [];
                        workoutsByType[w.type].push(w);
                    });
                    
                    const SPECIAL_TYPE_ID = 'DailySummary';
                    const dailyMap = {};
                    workouts.forEach(w => {
                        let dateStr = w.date;
                        if (!dateStr && w.id && typeof w.id === 'string') {
                            const parts = w.id.split('-');
                            if (parts.length >= 3) { dateStr = `${parts[0]}-${parts[1]}-${parts[2]}`; }
                        }
                        if (dateStr) {
                            if (!dailyMap[dateStr]) dailyMap[dateStr] = { date: dateStr, duration: 0, calories: 0, num: 0, distance: 0, id: `${dateStr}-sum` };
                            dailyMap[dateStr].duration += Number(w.duration || 0);
                            dailyMap[dateStr].calories += Number(w.calories || 0);
                            dailyMap[dateStr].num += Number(w.num || 0);
                            dailyMap[dateStr].distance += Number(w.distance || 0);
                        }
                    });
                    const dailyDataArray = Object.values(dailyMap).sort(sortByDate);

                    const rawUniqueTypes = Object.keys(workoutsByType).filter(type => type !== 'Swimming' && type !== 'æ¸¸æ³³');
                    const allTypesToDraw = [SPECIAL_TYPE_ID, ...rawUniqueTypes];
                    const chartColorPalette = [mainColor, secColor, '#22d3ee', '#a78bfa', '#f472b6', '#34d399'];

                    const chartObjects = allTypesToDraw.map(type => {
                        const config = sportConfigs[type] || {};
                        let row = config.row || 1;
                        if(row < 1) row = 1; if(row > 2) row = 2;
                        return { type, row, col: config.col || 1 };
                    });

                    const rowData = { 1: [], 2: [] };
                    chartObjects.forEach(obj => rowData[obj.row].push(obj));

                    [1, 2].forEach(rowIndex => {
                        const chartsInRow = rowData[rowIndex];
                        if (chartsInRow.length === 0) return;
                        chartsInRow.sort((a, b) => a.col - b.col);
                        const rowContentWidth = chartsInRow.length * cellWidth + (chartsInRow.length - 1) * gapX;
                        const rowStartX = (W - rowContentWidth) / 2;
                        const currentChartY = chartAreaTop + (rowIndex - 1) * (cellHeight + gapY);
                        const chartTitleAreaH = 120;
                        const chartDrawH = cellHeight - chartTitleAreaH - 40;
                        const chartPlotY = currentChartY + chartTitleAreaH;

                        chartsInRow.forEach((chartObj, i) => {
                            const type = chartObj.type;
                            const currentChartX = rowStartX + i * (cellWidth + gapX);
                            // å‡†å¤‡æ•°æ®ï¼štypeData ç”¨äºæ˜¾ç¤ºï¼ŒfullTypeData ç”¨äºåˆ¤æ–­è®°å½•æ•°
                            let fullTypeData, typeData;
                            if (type === SPECIAL_TYPE_ID) {
                                fullTypeData = dailyDataArray;
                                typeData = dailyDataArray.slice(-chartDataDays);
                            } else {
                                fullTypeData = workoutsByType[type].sort(sortByDate);
                                typeData = fullTypeData.slice(-chartDataDays);
                            }

                            const metricConfig = sportConfigs[type] || { mode: ChartMode.CURVE, metric: DataMetric.DURATION };
                            let metricKey = 'duration';
                            if (metricConfig.metric === DataMetric.CALORIES) metricKey = 'calories';
                            if (metricConfig.metric === DataMetric.STEPS) metricKey = 'num';
                            if (metricConfig.metric === DataMetric.DISTANCE) metricKey = 'distance';
                            
                            const currentColor = metricConfig.customColor || chartColorPalette[((rowIndex - 1) * 3 + i) % chartColorPalette.length];

                            // ç»˜åˆ¶æ ‡é¢˜
                            ctx.fillStyle = textColor; ctx.font = "bold 40px Inter"; ctx.textAlign = "center";
                            const sportMap = { 'Badminton': 'æ‰“ç¾½æ¯›çƒ', 'Running': 'è·‘æ­¥', 'Swimming': 'æ¸¸æ³³', 'Cycling': 'éª‘è¡Œ', 'Walking': 'å¾’æ­¥', 'Gym': 'å¥èº«', 'HIIT': 'é«˜å¼ºåº¦é—´æ­‡', 'Pilates': 'æ™®æ‹‰æ', [SPECIAL_TYPE_ID]: 'æ¯æ—¥è¿åŠ¨' };
                            ctx.fillText(sportMap[type] || type, currentChartX + cellWidth / 2, currentChartY + chartTitleAreaH / 2 - 15);
                            
                            // ç»˜åˆ¶å‰¯æ ‡é¢˜
                            ctx.font = "400 24px Inter"; ctx.fillStyle = 'rgba(255,255,255,0.5)';
                            let subLabel = metricConfig.metric === DataMetric.CALORIES ? 'çƒ­é‡æ¶ˆè€—' : (metricConfig.metric === DataMetric.STEPS ? 'è¡Œèµ°æ­¥æ•°' : (metricConfig.metric === DataMetric.DISTANCE ? 'è¿åŠ¨è·ç¦» (km)' : 'è¿åŠ¨æ—¶é•¿'));
                            ctx.fillText(`(${subLabel})`, currentChartX + cellWidth / 2, currentChartY + chartTitleAreaH / 2 + 25);
                            
                            // è®¡ç®—å¹¶ç»˜åˆ¶æé†’æ–‡æ¡ˆï¼ˆä½¿ç”¨å®Œæ•´æ•°æ®é•¿åº¦åˆ¤æ–­è®°å½•æ•°ï¼‰
                            const daysSince = calculateDaysSinceLastWorkout(typeData);
                            const recordCount = fullTypeData.length; // ä½¿ç”¨å®Œæ•´æ•°æ®é•¿åº¦
                            const reminderConfig = getReminderConfig(daysSince, type, recordCount);
                            
                            if (reminderConfig) {
                                ctx.font = "600 22px Inter";
                                ctx.fillStyle = reminderConfig.color;
                                ctx.textAlign = "center";
                                ctx.fillText(reminderConfig.text, currentChartX + cellWidth / 2, currentChartY + chartTitleAreaH / 2 + 60);
                            }

                            ctx.strokeStyle = 'rgba(255,255,255,0.2)'; ctx.lineWidth = 2;
                            ctx.beginPath(); ctx.moveTo(currentChartX, chartPlotY + chartDrawH); ctx.lineTo(currentChartX + cellWidth, chartPlotY + chartDrawH); ctx.stroke();

                            let rawMax = Math.max(...typeData.map(w => w[metricKey] || 0));
                            if (metricKey === 'num') rawMax = Math.max(rawMax, 10000);
                            const maxVal = rawMax * 1.2 || 60; 
                            const stepX = cellWidth / (typeData.length || 1);

                            // ç»˜åˆ¶åŸºç¡€çºµåæ ‡è½´çº¿
                            ctx.strokeStyle = 'rgba(255,255,255,0.15)';
                            ctx.lineWidth = 3;
                            ctx.beginPath();
                            ctx.moveTo(currentChartX, chartPlotY);
                            ctx.lineTo(currentChartX, chartPlotY + chartDrawH);
                            ctx.stroke();

                            // 1. ç»˜åˆ¶æ°´å¹³å‚è€ƒçº¿ (ä»…é™æ­¥æ•°æŒ‡æ ‡)
                            if (metricKey === 'num') {
                                const fullHistoryData = (type === SPECIAL_TYPE_ID) ? dailyDataArray : (workoutsByType[type] || []);
                                const allTimeAvg = fullHistoryData.length > 0 
                                    ? Math.round(fullHistoryData.reduce((sum, w) => sum + (w.num || 0), 0) / fullHistoryData.length) 
                                    : 0;

                                ctx.save();
                                ctx.setLineDash([15, 12]);
                                ctx.lineWidth = 2;
                                ctx.textAlign = "right";
                                ctx.font = "bold 20px Inter";

                                const y10k = chartPlotY + chartDrawH - ((10000 / maxVal) * chartDrawH);
                                ctx.strokeStyle = "rgba(255, 255, 255, 0.4)";
                                ctx.beginPath();
                                ctx.moveTo(currentChartX, y10k); ctx.lineTo(currentChartX + cellWidth, y10k);
                                ctx.stroke();
                                ctx.fillStyle = "rgba(255, 255, 255, 0.6)";
                                ctx.fillText("10,000æ­¥ç›®æ ‡", currentChartX + cellWidth, y10k - 10);

                                if (allTimeAvg > 0) {
                                    const yAvg = chartPlotY + chartDrawH - ((allTimeAvg / maxVal) * chartDrawH);
                                    ctx.strokeStyle = currentColor;
                                    ctx.globalAlpha = 0.5;
                                    ctx.beginPath();
                                    ctx.moveTo(currentChartX, yAvg); ctx.lineTo(currentChartX + cellWidth, yAvg);
                                    ctx.stroke();
                                    ctx.fillStyle = currentColor;
                                    ctx.globalAlpha = 0.8;
                                    ctx.fillText(`å†å²å¹³å‡: ${allTimeAvg.toLocaleString()}`, currentChartX + cellWidth, yAvg - 10);
                                }
                                ctx.restore();
                            }

                            // ä¼˜åŒ–åçš„å‘¨åˆ†éš”çº¿é€»è¾‘
                            // å¯»æ‰¾æœ¬å‘¨ç¬¬ä¸€ä¸ªæœ‰æ•°æ®çš„ç‚¹
                            const firstThisWeekIdx = typeData.findIndex(d => {
                                let dStr = d.date;
                                // å®¹é”™å¤„ç†ï¼šè‹¥æ—  date å±æ€§åˆ™ä» id ä¸­è§£æ
                                if (!dStr && d.id) {
                                    const parts = d.id.split('-');
                                    if (parts.length >= 3) dStr = `${parts[0]}-${parts[1]}-${parts[2]}`;
                                }
                                if (!dStr) return false;
                                const entryDate = new Date(dStr);
                                entryDate.setHours(0, 0, 0, 0);
                                return entryDate >= mondayDate;
                            });

                            // åˆ¤å®šæ¡ä»¶ï¼šæ‰¾åˆ°äº†æœ¬å‘¨æ•°æ®ï¼Œä¸”å®ƒä¸æ˜¯å›¾è¡¨çš„ç¬¬ä¸€æ¡æ•°æ®ï¼ˆæ„å‘³ç€å›¾è¡¨è·¨è¶Šäº†ä¸Šå‘¨å’Œæœ¬å‘¨ï¼‰
                            if (firstThisWeekIdx > 0) {
                                ctx.save();
                                // åæ ‡ä½ç½®ï¼šæœ¬å‘¨ç¬¬ä¸€ç‚¹å¯¹åº”æ§½ä½çš„å·¦ä¾§è¾¹ç¼˜ (currentChartX + index * stepX)
                                const mX = currentChartX + (firstThisWeekIdx * stepX);
                                ctx.setLineDash([15, 15]);
                                ctx.strokeStyle = "rgba(255, 255, 255, 0.3)"; // ä¿æŒä½é€æ˜åº¦ï¼Œä½œä¸ºè¾…åŠ©èƒŒæ™¯
                                ctx.lineWidth = 2;
                                ctx.beginPath();
                                ctx.moveTo(mX, chartPlotY);
                                ctx.lineTo(mX, chartPlotY + chartDrawH);
                                ctx.stroke();
                                ctx.restore();
                            }

                            // æ¢å¤å®çº¿çŠ¶æ€ï¼Œç»˜åˆ¶ Y è½´åˆ»åº¦å’Œæ ‡ç­¾
                            ctx.setLineDash([]);
                            ctx.fillStyle = 'rgba(255,255,255,0.4)';
                            ctx.font = 'bold 20px Inter';
                            ctx.textAlign = 'right';
                            ctx.textBaseline = 'middle';

                            const yTickRatios = [0, 0.25, 0.5, 0.75, 1];
                            yTickRatios.forEach(ratio => {
                                const y = chartPlotY + chartDrawH - (ratio * chartDrawH);
                                let value = Math.round(maxVal * ratio);
                                
                                // æ ¼å¼åŒ–å¤§æ•°å€¼ï¼ˆæ­¥æ•°ç­‰ï¼‰
                                let displayValue = value.toString();
                                if (metricKey === 'num' && value >= 1000) {
                                    displayValue = (value / 1000).toFixed(1) + 'k';
                                }
                                
                                // åˆ»åº¦çº¿
                                ctx.strokeStyle = 'rgba(255,255,255,0.1)';
                                ctx.lineWidth = 2;
                                ctx.beginPath();
                                ctx.moveTo(currentChartX, y);
                                ctx.lineTo(currentChartX + 8, y);
                                ctx.stroke();
                                
                                // æ¨ªå‘å‚è€ƒç½‘æ ¼çº¿ï¼ˆè™šçº¿ï¼‰
                                if (ratio > 0 && ratio < 1) {
                                    ctx.strokeStyle = 'rgba(255,255,255,0.05)';
                                    ctx.lineWidth = 1;
                                    ctx.setLineDash([5, 5]);
                                    ctx.beginPath();
                                    ctx.moveTo(currentChartX, y);
                                    ctx.lineTo(currentChartX + cellWidth, y);
                                    ctx.stroke();
                                    ctx.setLineDash([]);
                                }
                                
                                // æ•°å€¼æ ‡ç­¾
                                ctx.fillStyle = 'rgba(255,255,255,0.5)';
                                ctx.fillText(displayValue, currentChartX - 12, y);
                            });

                            if (metricConfig.mode === ChartMode.BAR) {
                                typeData.forEach((d, i) => {
                                    const val = d[metricKey] || 0; const h = (val/maxVal) * chartDrawH;
                                    const x = currentChartX + (i * stepX) + stepX * 0.1; const y = chartPlotY + chartDrawH - h; const bw = stepX * 0.8;
                                    ctx.fillStyle = currentColor; ctx.beginPath(); ctx.roundRect(x, y, bw, h, [15,15,0,0]); ctx.fill();
                                });
                            } else {
                                ctx.beginPath();
                                typeData.forEach((d, i) => {
                                    const val = d[metricKey] || 0; const x = currentChartX + (i * stepX) + stepX/2; const y = chartPlotY + chartDrawH - ((val / maxVal) * chartDrawH);
                                    if (i === 0) ctx.moveTo(x, y);
                                    else {
                                        if (metricConfig.mode === ChartMode.CURVE) {
                                            const prevVal = typeData[i-1][metricKey] || 0; 
                                            const prevX = currentChartX + ((i-1) * stepX) + stepX/2; const prevY = chartPlotY + chartDrawH - ((prevVal / maxVal) * chartDrawH);
                                            ctx.bezierCurveTo(prevX + (x-prevX)/2, prevY, prevX + (x-prevX)/2, y, x, y);
                                        } else { ctx.lineTo(x, y); }
                                    }
                                });
                                ctx.lineWidth = 8; ctx.strokeStyle = currentColor; ctx.shadowColor = currentColor; ctx.shadowBlur = 20;
                                ctx.stroke(); ctx.shadowBlur = 0;
                                typeData.forEach((d, i) => {
                                    const val = d[metricKey] || 0; const x = currentChartX + (i * stepX) + stepX/2; const y = chartPlotY + chartDrawH - ((val / maxVal) * chartDrawH);
                                    ctx.beginPath(); ctx.arc(x, y, 6, 0, Math.PI*2); ctx.fillStyle = "#fff"; ctx.fill();
                                });
                            }

                            if (typeData.length > 0) {
                                ctx.font = "bold 18px Inter"; ctx.fillStyle = 'rgba(255,255,255,0.6)'; ctx.textAlign = "center";
                                const skipRate = typeData.length > 10 ? 2 : 1;
                                typeData.forEach((d, i) => {
                                    if (i % skipRate !== 0) return;
                                    const cx = currentChartX + (i * stepX) + stepX / 2;
                                    let dateStr = "";
                                    if (d.id) { const parts = d.id.split('-'); if (parts.length >= 3) dateStr = `${parseInt(parts[1])}/${parseInt(parts[2])}`; }
                                    ctx.fillText(dateStr, cx, chartPlotY + chartDrawH + 40);
                                });
                            }
                        });
                    });
                };

                if (userImage) {
                    const img = new Image(); img.src = userImage; img.onload = () => renderFrame(img);
                } else {
                    renderFrame(null);
                }

            }, [insight, workouts, goals, visualSettings, sportConfigs, userImage, slogans]); 

            const downloadPoster = () => {
                const link = document.createElement('a');
                link.download = `fitposter-${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvasRef.current.toDataURL('image/png');
                link.click();
            };

            return (
                <div className="bg-card/50 flex flex-col h-full w-full overflow-hidden relative">
                    {isCropModalOpen && userImage && (
                        <ImageCropModal src={userImage} onConfirm={handleCropConfirm} onCancel={() => setIsCropModalOpen(false)} />
                    )}

                    <div className="px-6 py-4 flex flex-col xl:flex-row xl:items-center justify-between gap-4 shrink-0 bg-card border-b border-slate-800 z-10 shadow-sm">
                        <div>
                            <h2 className="text-xl font-bold text-white mb-1 flex items-center gap-2">
                                <Icon name="Sparkles" className="text-secondary" /> Wallpaper Generator
                            </h2>
                            <p className="text-slate-400 text-sm">Separated Charts by Sport Type</p>
                        </div>
                        
                        <div className="flex flex-wrap items-center gap-4">
                            <input type="file" ref={fileInputRef} onChange={handleImageUpload} className="hidden" accept="image/*" />
                            
                            <div className="flex items-center mr-2">
                                {userImage ? (
                                    <div className="flex items-center gap-2">
                                        <button onClick={() => setUserImage(null)} className="flex items-center gap-2 px-3 py-1.5 rounded-md text-xs font-medium bg-red-500/10 text-red-400 border border-red-500/50 hover:bg-red-500/20 transition-colors">
                                            <Icon name="Trash2" size={14} /> ç§»é™¤
                                        </button>
                                        {visualSettings.useImageAsBackground && (
                                            <button onClick={() => setIsCropModalOpen(true)} className="flex items-center gap-2 px-3 py-1.5 rounded-md text-xs font-medium bg-slate-700 text-white border border-slate-600 hover:bg-slate-600 transition-colors">
                                                <Icon name="Crop" size={14} /> è£å‰ª
                                            </button>
                                        )}
                                        <button onClick={() => onVisualSettingsChange({ ...visualSettings, imageShape: imageShape === 'circle' ? 'original' : 'circle' })} className="px-3 py-1.5 rounded-md text-xs font-medium bg-dark border border-slate-700 text-slate-300">
                                            {imageShape === 'circle' ? 'åœ†å½¢' : 'åŸå›¾'}
                                        </button>
                                        <button onClick={() => onVisualSettingsChange({ ...visualSettings, useImageAsBackground: !visualSettings.useImageAsBackground })} className={`px-3 py-1.5 rounded-md text-xs font-medium border ${visualSettings.useImageAsBackground ? 'bg-primary/20 border-primary text-primary' : 'bg-dark border-slate-700 text-slate-300'}`}>
                                            {visualSettings.useImageAsBackground ? 'èƒŒæ™¯å¼€å¯' : 'èƒŒæ™¯å…³é—­'}
                                        </button>
                                    </div>
                                ) : (
                                    <button onClick={() => fileInputRef.current.click()} className="flex items-center gap-2 px-3 py-1.5 rounded-md text-xs font-medium bg-dark border border-slate-700 text-slate-300 hover:text-white transition-all">
                                        <Icon name="ImagePlus" size={16} /> æ’å…¥å›¾ç‰‡
                                    </button>
                                )}
                            </div>

                            <div className="h-6 w-px bg-slate-700 mx-2"></div>

                            <div className="flex gap-2">
                                <Button onClick={downloadPoster} className="px-3 py-1.5 text-xs"><Icon name="Download" size={16} /> ä¸‹è½½ 4K</Button>
                                <Button onClick={handleRefresh} variant="secondary" className="px-3 py-1.5 text-xs"><Icon name="RefreshCw" size={16} /> åˆ·æ–°</Button>
                            </div>
                        </div>
                    </div>

                    <div className="flex-1 flex flex-col min-h-0 bg-dark relative p-4">
                        {workouts.length === 0 ? (
                            <div className="flex-1 border-2 border-dashed border-slate-700 rounded-xl flex flex-col items-center justify-center bg-dark/30 gap-4">
                                <Icon name="Dumbbell" size={48} className="text-slate-600" />
                                <p className="text-slate-400">æš‚æ— è¿åŠ¨æ•°æ®</p>
                            </div>
                        ) : (
                            <div className="flex-1 flex flex-col min-h-0 fade-in relative">
                                <div className="w-full h-full rounded-xl overflow-hidden shadow-2xl ring-1 ring-slate-700 flex items-center justify-center bg-dark/50">
                                    <canvas ref={canvasRef} className="max-w-full max-h-full object-contain" />
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        /**
         * ç»Ÿä¸€çš„æ–‡ä»¶ä¿å­˜å·¥å…·å‡½æ•°
         * ä¼˜å…ˆä½¿ç”¨ File System Access APIï¼Œä¸æ”¯æŒæ—¶é™çº§åˆ°ä¼ ç»Ÿä¸‹è½½
         * @param {string} content - æ–‡ä»¶å†…å®¹
         * @param {string} fileName - å»ºè®®çš„æ–‡ä»¶å
         * @param {string} mimeType - MIME ç±»å‹
         * @param {Object} directoryHandleRef - ç”¨äºå­˜å‚¨æ–‡ä»¶å¤¹å¥æŸ„çš„ ref å¯¹è±¡
         * @param {Object} fallbackWarningShownRef - ç”¨äºè®°å½•æ˜¯å¦å·²æ˜¾ç¤ºé™çº§æç¤ºçš„ ref å¯¹è±¡
         */
        const saveFileWithDialog = async (content, fileName, mimeType, directoryHandleRef, fallbackWarningShownRef) => {
            // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒ File System Access API
            if ('showSaveFilePicker' in window) {
                try {
                    const options = {
                        suggestedName: fileName,
                        types: [{
                            description: 'File',
                            accept: { [mimeType]: [fileName.split('.').pop()] }
                        }]
                    };

                    // å¦‚æœæœ‰è®°ä½çš„æ–‡ä»¶å¤¹å¥æŸ„ï¼Œä½¿ç”¨å®ƒä½œä¸ºèµ·å§‹ä½ç½®
                    if (directoryHandleRef.current) {
                        options.startIn = directoryHandleRef.current;
                    }

                    // æ˜¾ç¤º"å¦å­˜ä¸º"å¯¹è¯æ¡†
                    const handle = await window.showSaveFilePicker(options);
                    
                    // è·å–å¯å†™æµå¹¶å†™å…¥å†…å®¹
                    const writable = await handle.createWritable();
                    await writable.write(content);
                    await writable.close();

                    // å°è¯•è®°ä½çˆ¶æ–‡ä»¶å¤¹å¥æŸ„ï¼ˆç”¨äºä¸‹æ¬¡æ‰“å¼€ç›¸åŒä½ç½®ï¼‰
                    try {
                        // æ³¨æ„ï¼šgetDirectory() å¯èƒ½ä¸è¢«æ‰€æœ‰æµè§ˆå™¨æ”¯æŒ
                        // è¿™é‡Œæˆ‘ä»¬å°è¯•è·å–ï¼Œå¤±è´¥ä¹Ÿä¸å½±å“æ ¸å¿ƒåŠŸèƒ½
                        const parentHandle = await handle.getParent?.();
                        if (parentHandle) {
                            directoryHandleRef.current = parentHandle;
                        }
                    } catch (e) {
                        // é™é»˜å¤„ç†ï¼šæŸäº›æµè§ˆå™¨å¯èƒ½ä¸æ”¯æŒ getParent
                        console.debug('æ— æ³•è·å–çˆ¶æ–‡ä»¶å¤¹å¥æŸ„:', e);
                    }

                    return true; // ä¿å­˜æˆåŠŸ
                } catch (error) {
                    // ç”¨æˆ·å–æ¶ˆå¯¹è¯æ¡†ä¼šæŠ›å‡º AbortError
                    if (error.name === 'AbortError') {
                        // é™é»˜å¤„ç†å–æ¶ˆæ“ä½œ
                        return false;
                    }
                    
                    // å…¶ä»–é”™è¯¯ï¼šè®°å½•åˆ°æ§åˆ¶å°å¹¶é™çº§
                    console.warn('File System Access API å¤±è´¥ï¼Œé™çº§åˆ°ä¼ ç»Ÿä¸‹è½½:', error);
                    // ç»§ç»­æ‰§è¡Œé™çº§æ–¹æ¡ˆ
                }
            }

            // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ä¼ ç»Ÿçš„ <a> æ ‡ç­¾ä¸‹è½½æ–¹å¼
            // é¦–æ¬¡ä½¿ç”¨æ—¶æ˜¾ç¤ºæç¤º
            if (fallbackWarningShownRef && !fallbackWarningShownRef.current) {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè·¯å¾„é€‰æ‹©åŠŸèƒ½ï¼Œå°†ä½¿ç”¨é»˜è®¤ä¸‹è½½æ–¹å¼');
                fallbackWarningShownRef.current = true;
            }

            // åˆ›å»º Blob å’Œä¸‹è½½é“¾æ¥
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            return true;
        };

        const App = () => {
            const [workouts, setWorkouts] = useState([]);
            const [view, setView] = useState('log'); 
            
            // å¢åŠ æ ‡è¯­çŠ¶æ€
            const [slogans, setSlogans] = useState(() => {
                const saved = localStorage.getItem('fitposter_slogans');
                return saved || "- åšæŒå°±æ˜¯èƒœåˆ©\n- è®©æ±—æ°´å˜æˆå‹‹ç« \n- æ¯ä¸€æ»´æ±—æ°´éƒ½æ˜¯æˆåŠŸçš„åŸºçŸ³\n- è‡ªå¾‹å³è‡ªç”±\n- é‡æ–°å®šä¹‰ä½ çš„æé™";
            });

            const [visualSettings, setVisualSettings] = useState(() => {
                const saved = localStorage.getItem('fitposter_visual_settings');
                const defaultSettings = {
                    style: PosterStyle.NATURE,
                    imageSize: 300,
                    imageShape: 'circle',
                    useImageAsBackground: false,
                    bgOpacity: 0.15,
                    bgBlur: 60 
                };
                const settings = saved ? { ...defaultSettings, ...JSON.parse(saved) } : defaultSettings;
                return { ...settings, style: PosterStyle.NATURE }; 
            });

            const [goals, setGoals] = useState(() => {
                const saved = localStorage.getItem('fitposter_goals');
                return saved ? JSON.parse(saved) : { title: "", subtitle: "", targetDate: "" };
            });

            const [sportConfigs, setSportConfigs] = useState(() => {
                const saved = localStorage.getItem('fitposter_sport_configs');
                return saved ? JSON.parse(saved) : {};
            });

            // å…¨å±€å›¾è¡¨æ•°æ®å±•ç¤ºé‡è®¾ç½®ï¼ˆå•ä½ï¼šå¤©ï¼‰
            const [chartDataDays, setChartDataDays] = useState(() => {
                const saved = localStorage.getItem('fitposter_chart_data_days');
                return saved ? parseInt(saved) : 10;
            });

            // æ•°æ®æŒä¹…åŒ–
            useEffect(() => { localStorage.setItem('fitposter_visual_settings', JSON.stringify(visualSettings)); }, [visualSettings]);
            useEffect(() => { localStorage.setItem('fitposter_sport_configs', JSON.stringify(sportConfigs)); }, [sportConfigs]);
            // æŒä¹…åŒ–å›¾è¡¨æ•°æ®å±•ç¤ºé‡
            useEffect(() => { localStorage.setItem('fitposter_chart_data_days', chartDataDays.toString()); }, [chartDataDays]);

            useEffect(() => { localStorage.setItem('fitposter_goals', JSON.stringify(goals)); }, [goals]);
            useEffect(() => { localStorage.setItem('fitposter_slogans', slogans); }, [slogans]);

            useEffect(() => {
                const loadData = async () => {
                    const saved = localStorage.getItem('fitposter_workouts');
                    if (saved) { setWorkouts(JSON.parse(saved)); return; }
                    try {
                        const response = await fetch('./data/metadata.json');
                        if (response.ok) {
                            const jsonData = await response.json();
                            if (Array.isArray(jsonData)) setWorkouts(jsonData);
                        }
                    } catch (err) { console.log("No initial source found."); }
                };
                loadData();
            }, []);

            useEffect(() => {
                if (workouts.length > 0) localStorage.setItem('fitposter_workouts', JSON.stringify(workouts));
            }, [workouts]);

            return (
                <div className="min-h-screen bg-dark text-slate-200 flex flex-col">
                    <nav className="bg-dark/80 backdrop-blur-md border-b border-slate-800 sticky top-0 z-50 shrink-0">
                        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2 cursor-pointer" onClick={() => setView('log')}>
                                <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-primary to-secondary flex items-center justify-center">
                                    <Icon name="Dumbbell" className="text-white" size={20} />
                                </div>
                                <span className="font-bold text-xl text-white">FitPoster Local</span>
                            </div>
                            
                            <div className="flex gap-2 bg-card/50 p-1 rounded-lg border border-slate-700">
                                <button onClick={() => setView('log')} className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all flex items-center gap-2 ${view === 'log' ? 'bg-slate-700 text-white shadow' : 'text-slate-400 hover:text-white'}`}>
                                    <Icon name="Activity" size={16} /> æ•°æ®ç®¡ç†
                                </button>
                                <button onClick={() => setView('poster')} className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all flex items-center gap-2 ${view === 'poster' ? 'bg-primary text-dark shadow font-bold' : 'text-slate-400 hover:text-white'}`}>
                                    <Icon name="Sparkles" size={16} /> ç”Ÿæˆå£çº¸
                                </button>
                            </div>
                        </div>
                    </nav>

                    <main className="flex-1 overflow-hidden flex flex-col">
                        {view === 'log' && (
                            <div className="flex-1 overflow-y-auto custom-scrollbar bg-dark">
                                <div className="max-w-7xl mx-auto px-4 py-8 space-y-8">
                                    {/* æ•°æ®ç®¡ç†é¡¶éƒ¨ç½‘æ ¼ï¼šæ”¹ä¸ºä¸‰åˆ— */}
                                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                        <div className="lg:col-span-1">
                                            <DataOverviewPanel workouts={workouts} goals={goals} onGoalsChange={setGoals} />
                                        </div>
                                        <div className="lg:col-span-1 min-h-[400px]">
                                            <SloganManager slogans={slogans} onUpdate={setSlogans} />
                                        </div>
                                        <div className="lg:col-span-1 min-h-[400px]">
                                            <JsonEditor workouts={workouts} onUpdate={setWorkouts} />
                                        </div>
                                    </div>
                                    <div>
                                        <VisualConfigPanel 
                                            workouts={workouts} sportConfigs={sportConfigs}
                                            onConfigChange={(newConfigs) => setSportConfigs(newConfigs)} 
                                            visualSettings={visualSettings}
                                            chartDataDays={chartDataDays}
                                            onChartDataDaysChange={setChartDataDays}
                                        />
                                    </div>
                                    <div className="h-8"></div>
                                </div>
                            </div>
                        )}

                        {view === 'poster' && (
                            <div className="flex-1 bg-dark flex flex-col h-full overflow-hidden">
                                <PosterGenerator 
                                    workouts={workouts} goals={goals}
                                    visualSettings={visualSettings} sportConfigs={sportConfigs}
                                    onVisualSettingsChange={setVisualSettings}
                                    slogans={slogans}
                                    chartDataDays={chartDataDays}
                                />
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    
    <!-- èµ„æºåŠ è½½æ£€æµ‹è„šæœ¬ -->
    <script>
        // é‡è¯•è®¡æ•°å™¨ï¼ˆä½¿ç”¨ sessionStorage è·¨é¡µé¢åˆ·æ–°ä¿æŒï¼‰
        const RETRY_COUNT_KEY = 'fitposter_retry_count';
        
        function getRetryCount() {
            return parseInt(sessionStorage.getItem(RETRY_COUNT_KEY) || '0');
        }
        
        function incrementRetryCount() {
            const count = getRetryCount() + 1;
            sessionStorage.setItem(RETRY_COUNT_KEY, count.toString());
            return count;
        }
        
        function resetRetryCount() {
            sessionStorage.removeItem(RETRY_COUNT_KEY);
        }
        
        // æ£€æµ‹å…³é”®èµ„æºæ˜¯å¦åŠ è½½æˆåŠŸ
        function checkResources() {
            const resources = [
                { name: 'React', check: () => typeof window.React !== 'undefined', label: 'React æ ¸å¿ƒåº“æœªåŠ è½½' },
                { name: 'ReactDOM', check: () => typeof window.ReactDOM !== 'undefined', label: 'ReactDOM åº“æœªåŠ è½½' },
                { name: 'Babel', check: () => typeof window.Babel !== 'undefined', label: 'Babel è½¬è¯‘å™¨æœªåŠ è½½' },
                { name: 'Tailwind', check: () => typeof window.tailwind !== 'undefined', label: 'Tailwind CSS æœªåŠ è½½' }
            ];
            
            const failed = resources.filter(r => !r.check());
            return {
                success: failed.length === 0,
                failed: failed
            };
        }
        
        // æ˜¾ç¤ºé”™è¯¯ç•Œé¢
        function showError(failedResources) {
            const loadingState = document.getElementById('loading-state');
            const errorState = document.getElementById('error-state');
            const errorDetails = document.getElementById('error-details');
            
            // éšè— Loadingï¼Œæ˜¾ç¤ºé”™è¯¯
            loadingState.style.display = 'none';
            errorState.style.display = 'block';
            
            // å¡«å……å¤±è´¥é¡¹åˆ—è¡¨
            errorDetails.innerHTML = failedResources.map(r => 
                `<div class="error-item">${r.label}</div>`
            ).join('');
            
            // æ£€æŸ¥é‡è¯•æ¬¡æ•°ï¼Œæ˜¾ç¤ºè­¦å‘Š
            const retryCount = getRetryCount();
            if (retryCount >= 3) {
                const warning = document.getElementById('retry-warning');
                warning.classList.add('show');
            }
        }
        
        // å¤„ç†é‡è¯•æŒ‰é’®ç‚¹å‡»
        function handleRetry() {
            incrementRetryCount();
            location.reload();
        }
        
        // åˆ‡æ¢å¸®åŠ©ä¿¡æ¯æ˜¾ç¤º
        function toggleHelp() {
            const helpSection = document.getElementById('help-section');
            helpSection.classList.toggle('show');
        }
        
        // éšè—åŠ è½½è¦†ç›–å±‚
        function hideLoader() {
            const overlay = document.getElementById('resource-loader-overlay');
            overlay.classList.add('hidden');
            
            // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ ï¼ˆé‡Šæ”¾èµ„æºï¼‰
            setTimeout(() => {
                overlay.remove();
            }, 300);
            
            // åŠ è½½æˆåŠŸï¼Œé‡ç½®é‡è¯•è®¡æ•°å™¨
            resetRetryCount();
        }
        
        // æ‰§è¡Œæ£€æµ‹
        (function() {
            // ç­‰å¾…å½“å‰è„šæœ¬æ‰§è¡Œå®Œæˆåç«‹å³æ£€æµ‹
            setTimeout(() => {
                const result = checkResources();
                
                if (result.success) {
                    // æ‰€æœ‰èµ„æºåŠ è½½æˆåŠŸ
                    hideLoader();
                } else {
                    // æœ‰èµ„æºåŠ è½½å¤±è´¥
                    showError(result.failed);
                }
            }, 0);
        })();
    </script>
</body>
</html>