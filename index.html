<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FitPoster - 健身壁纸生成器</title>
    
    <!-- Tailwind CSS (样式库) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#00D4FF',
              secondary: '#FF0055',
              dark: '#0F172A',
              card: '#1E293B',
            },
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
          },
        },
      }
    </script>
    
    <!-- React & ReactDOM (核心框架) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (让浏览器能运行 React 代码) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
      body {
        font-family: 'Inter', sans-serif;
        background-color: #0F172A;
        color: white;
      }
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: #0F172A; }
      ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #475569; }
      
      /* Animation Utilities */
      .fade-in { animation: fadeIn 0.5s ease-in; }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- 核心应用代码 -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 1. 图标组件 (SVG Paths) ---
        const ICONS = {
            Dumbbell: <path d="M6.5 6.5l11 11M21 21l-1-1a2.828 2.828 0 0 1 0-4l1-1m-17 6l1-1a2.828 2.828 0 0 0 0-4l-1-1m17-10l-4.5 4.5M3 3l1 1a2.828 2.828 0 0 0 4 0l1-1m-6 5l4.5-4.5m1 11l4-4" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" fill="none"/>,
            PlusCircle: <g fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 8v8M8 12h8"/></g>,
            Flame: <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.5-3.3.3-1.1.9-2.07 1.8-2.2.2.14.3.4.2.7z" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
            Clock: <g fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></g>,
            Download: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
            Upload: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
            Save: <g fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></g>,
            Sparkles: <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
            RefreshCw: <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8M21 3v5h-5M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16M3 21v-5h5" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
            BarChart3: <path d="M3 3v18h18M18 17V9M13 17V5M8 17v-3" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
            Palette: <path d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5-5 4 4 0 0 1-5-5m-6.5 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0m2.5 4a1 1 0 1 1-2 0 1 1 0 0 1 2 0m3 4a1 1 0 1 1-2 0 1 1 0 0 1 2 0" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
            Activity: <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
            Database: <g fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></g>,
            PieChart: <g fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></g>,
            LineChart: <g fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"/><path d="M18 9l-5 5-4-4-6 6"/></g>,
            Image: <rect x="3" y="3" width="18" height="18" rx="2" ry="2" stroke="currentColor" strokeWidth="2" fill="none" strokeLinecap="round" strokeLinejoin="round"></rect>,
            ImagePlus: <g fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7"/><line x1="16" y1="5" x2="22" y2="5"/><line x1="19" y1="2" x2="19" y2="8"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></g>,
            Trash2: <g fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></g>,
            // MapPin
            MapPin: <g fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></g>
        };

        // 图表模式与数据维度
        const ChartMode = {
            CURVE: 'Curve',    // 曲线
            LINE: 'Line',      // 折线
            BAR: 'Bar'         // 柱状
        };

        const DataMetric = {
            DURATION: 'Duration', // 时长
            CALORIES: 'Calories',  // 热量
            STEPS: 'Steps',       // 步数
            DISTANCE: 'Distance'  // 距离
        };

        const Icon = ({ name, size = 20, className = "" }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                className={className}
            >
                {ICONS[name] || null}
            </svg>
        );

        // --- 2. 服务逻辑 (本地数据生成) ---
        const QUOTES = {
            high_calorie: ["能量爆棚！", "燃烧吧，卡路里！", "极限突破", "纯粹的力量", "重新定义极限"],
            consistency: ["坚持就是胜利", "又赢了一天", "积少成多", "进步胜过完美", "自律即自由"],
            generic: ["数据可视化你的努力", "让汗水变成艺术", "专注目标", "运动即生命", "每一步都算数"]
        };

        const PosterStyle = {
            CYBERPUNK: 'Cyberpunk Neon',
            NATURE: 'Zen Nature',
            MINIMALIST: 'Clean Minimalist',
            HEATMAP: 'Intense Heat',
        };

        const ChartType = {
            LINE: 'Trend Line',
            BAR: 'Bar Chart',
        };

        // 排版模式定义
        const LayoutMode = {
            ROW: 'Row',       // 单行 (默认, 最多3个)
            GRID: 'Grid',     // 网格 (两行, 最多6个)
            FOCUS: 'Focus'    // 聚焦 (单一大图, 最多1个)
        };

        const generatePosterInsight = (workouts) => {
            const totalCals = workouts.reduce((sum, w) => sum + w.calories, 0);
            let pool = QUOTES.generic;
            if (totalCals > 2000) pool = [...pool, ...QUOTES.high_calorie];
            if (workouts.length > 5) pool = [...pool, ...QUOTES.consistency];
            
            const randomQuote = pool[Math.floor(Math.random() * pool.length)];
            return randomQuote;
        };

        // --- 3. 基础组件 ---
        const Button = ({ children, variant = 'primary', className = '', onClick, ...props }) => {
            const base = "px-4 py-2 rounded-lg font-semibold transition-all duration-200 flex items-center justify-center gap-2 active:scale-95 disabled:opacity-50";
            const variants = {
                primary: "bg-primary text-dark hover:bg-cyan-400 shadow-lg shadow-cyan-500/30",
                secondary: "bg-secondary text-white hover:bg-rose-600 shadow-lg shadow-rose-500/30",
                outline: "border-2 border-slate-600 text-slate-300 hover:border-primary hover:text-primary bg-transparent",
                ghost: "bg-transparent text-slate-400 hover:text-white hover:bg-slate-800"
            };
            return (
                <button onClick={onClick} className={`${base} ${variants[variant]} ${className}`} {...props}>
                    {children}
                </button>
            );
        };

        // --- 4. 业务组件 ---
        // 增加 workouts 属性接收，用于计算 ID 序号
        const WorkoutForm = ({ onAddWorkout, workouts }) => {
            const [type, setType] = useState('');
            const [duration, setDuration] = useState('');
            const [calories, setCalories] = useState('');
            const [num, setNum] = useState(''); // 步数输入
            const [notes, setNotes] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!type) return;

                const today = new Date().toISOString().split('T')[0];
                
                // 计算当天序号 (ID 格式: YYYY-MM-DD-N)
                const count = workouts.filter(w => w.date === today).length + 1;
                const newId = `${today}-${count}`;

                const newWorkout = {
                    id: newId,
                    type: type.trim(), 
                    duration: parseInt(duration) || 0,
                    calories: parseInt(calories) || 0,
                    num: parseInt(num) || 0, // 保存步数
                    date: today,
                    notes
                };
                onAddWorkout(newWorkout);
                setType(''); setDuration(''); setCalories(''); setNum(''); setNotes('');
            };

            return (
                <div className="bg-card p-6 rounded-2xl shadow-xl border border-slate-800">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold text-white flex items-center gap-2">
                            <Icon name="PlusCircle" className="text-primary" /> Log Workout
                        </h2>
                    </div>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-slate-400 mb-1">Exercise Type</label>
                            <div className="relative">
                                <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"><Icon name="Dumbbell" size={16} /></div>
                                <input type="text" value={type} onChange={(e) => setType(e.target.value)} placeholder="e.g. 每日行走步数, Running" className="w-full bg-dark border border-slate-700 rounded-lg py-2 pl-10 pr-4 text-white focus:outline-none focus:border-primary transition-colors" required />
                            </div>
                        </div>
                        <div className="grid grid-cols-3 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-400 mb-1">Duration</label>
                                <div className="relative">
                                    <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"><Icon name="Clock" size={16} /></div>
                                    <input type="number" value={duration} onChange={(e) => setDuration(e.target.value)} placeholder="min" className="w-full bg-dark border border-slate-700 rounded-lg py-2 pl-10 pr-4 text-white focus:outline-none focus:border-primary transition-colors" />
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-400 mb-1">Calories</label>
                                <div className="relative">
                                    <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"><Icon name="Flame" size={16} /></div>
                                    <input type="number" value={calories} onChange={(e) => setCalories(e.target.value)} placeholder="kcal" className="w-full bg-dark border border-slate-700 rounded-lg py-2 pl-10 pr-4 text-white focus:outline-none focus:border-primary transition-colors" />
                                </div>
                            </div>
                            {/* 步数输入框 */}
                            <div>
                                <label className="block text-sm font-medium text-slate-400 mb-1">Steps</label>
                                <div className="relative">
                                    <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"><Icon name="Activity" size={16} /></div>
                                    <input type="number" value={num} onChange={(e) => setNum(e.target.value)} placeholder="num" className="w-full bg-dark border border-slate-700 rounded-lg py-2 pl-10 pr-4 text-white focus:outline-none focus:border-primary transition-colors" />
                                </div>
                            </div>
                        </div>
                        <Button type="submit" className="w-full">Save Entry</Button>
                    </form>
                </div>
            );
        };

        // --- 组件：JSON 编辑器 (含文件导入/导出功能) ---
        const JsonEditor = ({ workouts, onUpdate }) => {
            const [jsonText, setJsonText] = useState(JSON.stringify(workouts, null, 2));
            const [error, setError] = useState(null);
            const fileInputRef = useRef(null);

            // 同步数据
            useEffect(() => {
                setJsonText(JSON.stringify(workouts, null, 2));
            }, [workouts]);

            // 保存到 App 状态 (应用更改)
            const handleApply = () => {
                try {
                    const parsed = JSON.parse(jsonText);
                    if (!Array.isArray(parsed)) throw new Error("数据格式错误：根节点必须是数组 [...]");
                    onUpdate(parsed);
                    setError(null);
                    alert("数据已更新到当前视图！");
                } catch (err) {
                    setError(err.message);
                }
            };

            // 导出 JSON 文件 
            const handleExport = () => {
                try {
                    // 验证一下 JSON 格式是否正确再导出
                    JSON.parse(jsonText);
                    
                    const blob = new Blob([jsonText], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `fitposter-data-${new Date().toISOString().slice(0,10)}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                } catch (err) {
                    setError("导出失败：当前编辑器内容的 JSON 格式不正确");
                }
            };

            // 导入 JSON 文件
            const handleFileImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const content = e.target.result;
                        const parsed = JSON.parse(content);
                        if (!Array.isArray(parsed)) throw new Error("文件格式错误：JSON 内容必须是数组 [...]");
                        
                        onUpdate(parsed);
                        setJsonText(JSON.stringify(parsed, null, 2));
                        setError(null);
                        alert(`成功导入 ${parsed.length} 条记录！`);
                    } catch (err) {
                        setError("导入失败: " + err.message);
                        alert("导入失败，请检查文件。");
                    }
                    event.target.value = '';
                };
                reader.readAsText(file);
            };

            return (
                <div className="bg-card p-6 rounded-2xl shadow-xl border border-slate-800 h-full flex flex-col">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold text-white flex items-center gap-2">
                            <Icon name="Database" className="text-primary" /> JSON Data
                        </h2>
                        
                        <div className="flex gap-2">
                            <input type="file" ref={fileInputRef} onChange={handleFileImport} className="hidden" accept=".json" />
                            
                            {/* 导入按钮 */}
                            <Button onClick={() => fileInputRef.current.click()} variant="outline" className="text-xs px-3 py-1" title="Import JSON">
                                <Icon name="Upload" size={14} /> 导入
                            </Button>

                            {/* 导出按钮 */}
                            <Button onClick={handleExport} variant="outline" className="text-xs px-3 py-1" title="Export JSON">
                                <Icon name="Save" size={14} /> 备份
                            </Button>

                            {/* 应用更改按钮 */}
                            <Button onClick={handleApply} size="sm" className="text-xs px-3 py-1" title="Apply changes to view">
                                应用
                            </Button>
                        </div>
                    </div>
                    
                    {error && <div className="mb-2 text-red-400 text-xs bg-red-900/20 p-2 rounded">{error}</div>}
                    
                    <textarea
                        className="flex-1 w-full bg-dark border border-slate-700 rounded-lg p-4 text-xs font-mono text-slate-300 focus:outline-none focus:border-primary resize-none leading-relaxed custom-scrollbar"
                        value={jsonText}
                        onChange={(e) => setJsonText(e.target.value)}
                        spellCheck="false"
                        placeholder="数据将显示在这里。您可以导入 .json 文件，或手动编辑后点击“应用”。"
                    />
                    <p className="text-slate-500 text-xs mt-2">推荐定期点击“备份”按钮，将数据保存为 .json 文件到本地。</p>
                </div>
            );
        };

        // --- 组件：迷你图表预览 ---
        const MiniChartPreview = ({ data, mode, metric }) => {
            const canvasRef = useRef(null);

            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas || !data || data.length === 0) return;

                const ctx = canvas.getContext('2d');
                const dpr = window.devicePixelRatio || 1;
                
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width * dpr;
                canvas.height = rect.height * dpr;
                ctx.scale(dpr, dpr);

                const W = rect.width;
                const H = rect.height;
                const padding = 10;
                const drawW = W - padding * 2;
                const drawH = H - padding * 2;

                ctx.clearRect(0, 0, W, H);

                // 确定颜色：时长(青), 热量(粉), 步数(绿), 距离(紫)
                let color = '#00D4FF';
                if (metric === DataMetric.CALORIES) color = '#FF0055';
                if (metric === DataMetric.STEPS) color = '#10B981'; 
                if (metric === DataMetric.DISTANCE) color = '#A855F7'; // Purple-500
                
                // 准备数据: 根据 metric 获取对应字段
                let metricKey = 'duration';
                if (metric === DataMetric.CALORIES) metricKey = 'calories';
                if (metric === DataMetric.STEPS) metricKey = 'num';
                if (metric === DataMetric.DISTANCE) metricKey = 'distance';

                const values = data.map(d => d[metricKey] || 0);
                const maxVal = Math.max(...values, 1) * 1.1; 

                ctx.strokeStyle = color;
                ctx.fillStyle = color;
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';

                const stepX = drawW / (values.length - 1 || 1);

                // ... (后续绘制逻辑 mode === ChartMode.BAR 等保持不变，通用逻辑已解耦) ...
                if (mode === ChartMode.BAR) {
                    const barWidth = (drawW / values.length) * 0.6;
                    values.forEach((val, i) => {
                        const h = (val / maxVal) * drawH;
                        const x = padding + (i * (drawW / values.length)) + (drawW / values.length - barWidth) / 2;
                        const y = H - padding - h;
                        ctx.beginPath();
                        if (ctx.roundRect) ctx.roundRect(x, y, barWidth, h, [4, 4, 0, 0]);
                        else ctx.rect(x, y, barWidth, h);
                        ctx.fill();
                    });
                } else {
                    ctx.beginPath();
                    if (values.length === 1) {
                        const val = values[0];
                        const y = H - padding - ((val / maxVal) * drawH);
                        ctx.moveTo(padding, y); ctx.lineTo(W - padding, y);
                    } else {
                        values.forEach((val, i) => {
                            const x = padding + i * stepX;
                            const y = H - padding - ((val / maxVal) * drawH);
                            if (i === 0) ctx.moveTo(x, y);
                            else {
                                if (mode === ChartMode.CURVE) {
                                    const prevVal = values[i - 1];
                                    const prevX = padding + (i - 1) * stepX;
                                    const prevY = H - padding - ((prevVal / maxVal) * drawH);
                                    const midX = (prevX + x) / 2;
                                    ctx.bezierCurveTo(midX, prevY, midX, y, x, y);
                                } else { ctx.lineTo(x, y); }
                            }
                        });
                    }
                    ctx.shadowColor = color; ctx.shadowBlur = 10; ctx.stroke(); ctx.shadowBlur = 0;
                    ctx.fillStyle = '#1E293B'; ctx.lineWidth = 2;
                    values.forEach((val, i) => {
                        const x = padding + i * stepX;
                        const y = H - padding - ((val / maxVal) * drawH);
                        ctx.beginPath(); ctx.arc(x, y, 3, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
                    });
                }
            }, [data, mode, metric]);

            return <canvas ref={canvasRef} className="w-full h-32 rounded-lg bg-dark/50 border border-slate-700/50" />;
        };

        // // --- 组件：数据概览面板 (仅统计) ---
        const DataOverviewPanel = ({ workouts, goals, onGoalsChange }) => {
            const stats = {
                count: workouts.length,
                totalDuration: workouts.reduce((sum, w) => sum + (w.duration || 0), 0),
                totalCalories: workouts.reduce((sum, w) => sum + (w.calories || 0), 0),
                totalSteps: workouts.reduce((sum, w) => sum + (w.num || 0), 0),
                avgDuration: workouts.length ? Math.round(workouts.reduce((sum, w) => sum + (w.duration || 0), 0) / workouts.length) : 0
            };

            return (
                <div className="bg-card p-6 rounded-2xl shadow-xl border border-slate-800 h-full">
                    <h2 className="text-xl font-bold text-white flex items-center gap-2 mb-6">
                        <Icon name="Activity" className="text-primary" /> 数据概览
                    </h2>

                    {/* 目标编辑区域 */}
                    <div className="mb-6 p-4 bg-dark/30 rounded-xl border border-dashed border-slate-700">
                        <div className="mb-3">
                            <label className="block text-[10px] uppercase font-bold text-slate-500 mb-1">一级大目标 (Major Goal)</label>
                            <input 
                                type="text" 
                                value={goals?.title || ""} 
                                onChange={(e) => onGoalsChange({...goals, title: e.target.value})}
                                className="w-full bg-dark border border-slate-600 rounded px-3 py-1.5 text-white font-bold focus:border-primary focus:outline-none transition-colors"
                                placeholder="例如：2025 健身计划"
                            />
                        </div>
                        <div>
                            <label className="block text-[10px] uppercase font-bold text-slate-500 mb-1">二级小目标 (Subtitle)</label>
                            <input 
                                type="text" 
                                value={goals?.subtitle || ""} 
                                onChange={(e) => onGoalsChange({...goals, subtitle: e.target.value})}
                                className="w-full bg-dark border border-slate-600 rounded px-3 py-1.5 text-sm text-slate-300 focus:border-primary focus:outline-none transition-colors"
                                placeholder="例如：自律即自由"
                            />
                        </div>
                    </div>

                    {/* 为了美观，如果格子变多了，可以考虑改为 lg:grid-cols-3，这里保持 grid-cols-2 即可，会自动换行 */}
                    <div className="grid grid-cols-2 gap-4">
                        <div className="bg-dark/50 p-4 rounded-xl border border-slate-700">
                            <div className="text-slate-400 text-xs mb-1">累计运动</div>
                            <div className="text-2xl font-bold text-white">{stats.count} <span className="text-sm font-normal text-slate-500">次</span></div>
                        </div>
                        <div className="bg-dark/50 p-4 rounded-xl border border-slate-700">
                            <div className="text-slate-400 text-xs mb-1">累计时长</div>
                            <div className="text-2xl font-bold text-primary">{stats.totalDuration} <span className="text-sm font-normal text-slate-500">min</span></div>
                        </div>
                        <div className="bg-dark/50 p-4 rounded-xl border border-slate-700">
                            <div className="text-slate-400 text-xs mb-1">消耗热量</div>
                            <div className="text-2xl font-bold text-secondary">{stats.totalCalories.toLocaleString()} <span className="text-sm font-normal text-slate-500">kcal</span></div>
                        </div>
                        
                        {/* --- 总步数显示卡片 (绿色) --- */}
                        <div className="bg-dark/50 p-4 rounded-xl border border-slate-700">
                            <div className="text-slate-400 text-xs mb-1">累计步数</div>
                            <div className="text-2xl font-bold text-emerald-400">{stats.totalSteps.toLocaleString()} <span className="text-sm font-normal text-slate-500">steps</span></div>
                        </div>

                        <div className="bg-dark/50 p-4 rounded-xl border border-slate-700">
                            <div className="text-slate-400 text-xs mb-1">平均时长</div>
                            <div className="text-2xl font-bold text-white">{stats.avgDuration} <span className="text-sm font-normal text-slate-500">min</span></div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 组件：分项可视化配置面板 (完全展开) ---
        const VisualConfigPanel = ({ workouts, sportConfigs, onConfigChange }) => {
            const uniqueTypes = [...new Set(workouts.map(w => w.type))]
                .filter(t => t !== 'Swimming' && t !== '游泳')
                .sort();

            const updateSportConfig = (type, key, value) => {
                const currentConfig = sportConfigs[type] || { mode: ChartMode.CURVE, metric: DataMetric.DURATION };
                onConfigChange({
                    ...sportConfigs,
                    [type]: { ...currentConfig, [key]: value }
                });
            };

            return (
                <div className="bg-card p-6 rounded-2xl shadow-xl border border-slate-800 w-full">
                    <h2 className="text-xl font-bold text-white flex items-center gap-2 mb-6">
                        <Icon name="Palette" className="text-secondary" /> 分项可视化配置
                    </h2>
                    
                    {uniqueTypes.length === 0 ? (
                        <div className="text-slate-500 text-sm italic p-4 bg-dark/30 rounded-lg border border-slate-800">暂无运动数据，请先录入。</div>
                    ) : (
                        // 使用 Grid 布局自动换行，不再使用 overflow-y-auto
                        <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                            {uniqueTypes.map((type, index) => {
                                // 默认分配位置
                                const defaultRow = Math.floor(index / 3) + 1;
                                const defaultCol = (index % 3) + 1;
                                
                                const config = sportConfigs[type] || { 
                                    mode: ChartMode.CURVE, 
                                    metric: DataMetric.DURATION, 
                                    row: defaultRow > 2 ? 2 : defaultRow, 
                                    col: defaultCol 
                                };
                                
                                const typeData = workouts
                                    .filter(w => w.type === type)
                                    .sort((a, b) => new Date(a.date) - new Date(b.date))
                                    .slice(-10);

                                // 检查数据可用性
                                const hasDuration = typeData.reduce((sum, w) => sum + (w.duration || 0), 0) > 0;
                                const hasCalories = typeData.reduce((sum, w) => sum + (w.calories || 0), 0) > 0;
                                const hasSteps = typeData.reduce((sum, w) => sum + (w.num || 0), 0) > 0;
                                const hasDistance = typeData.reduce((sum, w) => sum + (w.distance || 0), 0) > 0; 

                                // 如果全是0（刚添加未记录），默认显示时长
                                const showAll = !hasDuration && !hasCalories && !hasSteps && !hasDistance; // (更新条件)

                                return (
                                    <div key={type} className="bg-dark/30 border border-slate-700 p-5 rounded-2xl hover:border-slate-600 transition-all">
                                        <div className="flex items-center justify-between mb-4">
                                            <div className="font-bold text-lg text-white border-l-4 border-primary pl-3">{type}</div>
                                            <span className="text-xs text-slate-500 bg-dark px-2 py-1 rounded border border-slate-800">{typeData.length} 记录</span>
                                        </div>

                                        <div className="mb-4">
                                            <MiniChartPreview data={typeData} mode={config.mode} metric={config.metric} />
                                        </div>
                                        
                                        <div className="space-y-3">
                                            <div>
                                                <label className="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1 block">Grid Position</label>
                                                <div className="flex gap-2">
                                                    <div className="flex-1">
                                                        <span className="text-[10px] text-slate-500 mb-0.5 block">Row (行)</span>
                                                        <select 
                                                            value={config.row || 1} 
                                                            onChange={(e) => updateSportConfig(type, 'row', parseInt(e.target.value))}
                                                            className="w-full bg-dark border border-slate-800 rounded px-2 py-1.5 text-xs text-white focus:border-primary focus:outline-none appearance-none"
                                                        >
                                                            <option value={1}>第 1 行</option>
                                                            <option value={2}>第 2 行</option>
                                                        </select>
                                                    </div>
                                                    <div className="flex-1">
                                                        <span className="text-[10px] text-slate-500 mb-0.5 block">Col (排序/列)</span>
                                                        <select 
                                                            value={config.col || 1} 
                                                            onChange={(e) => updateSportConfig(type, 'col', parseInt(e.target.value))}
                                                            className="w-full bg-dark border border-slate-800 rounded px-2 py-1.5 text-xs text-white focus:border-primary focus:outline-none appearance-none"
                                                        >
                                                            <option value={1}>1 (左)</option>
                                                            <option value={2}>2 (中)</option>
                                                            <option value={3}>3 (右)</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>

                                            <div>
                                                <label className="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1 block">Chart Type</label>
                                                <div className="flex gap-1 bg-dark rounded-lg p-1 border border-slate-800">
                                                    {[
                                                        { id: ChartMode.CURVE, label: '曲线', icon: 'Activity' },
                                                        { id: ChartMode.LINE, label: '折线', icon: 'LineChart' },
                                                        { id: ChartMode.BAR, label: '柱状', icon: 'BarChart3' }
                                                    ].map(opt => (
                                                        <button
                                                            key={opt.id}
                                                            onClick={() => updateSportConfig(type, 'mode', opt.id)}
                                                            className={`flex-1 flex items-center justify-center gap-1 py-1.5 rounded text-[10px] font-medium transition-all ${config.mode === opt.id ? 'bg-slate-700 text-white shadow-sm' : 'text-slate-500 hover:text-slate-300 hover:bg-slate-800'}`}
                                                        >
                                                            <Icon name={opt.icon} size={12} /> {opt.label}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                            
                                            {/* --- 修改：仅显示有数据的维度 --- */}
                                            <div>
                                                <label className="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1 block">Metric</label>
                                                <div className="flex gap-1 bg-dark rounded-lg p-1 border border-slate-800">
                                                    {(showAll || hasDuration) && (
                                                        <button
                                                            onClick={() => updateSportConfig(type, 'metric', DataMetric.DURATION)}
                                                            className={`flex-1 flex items-center justify-center gap-1 py-1.5 rounded text-[10px] font-medium transition-all ${config.metric === DataMetric.DURATION ? 'bg-primary/10 text-primary border border-primary/50' : 'text-slate-500 hover:text-slate-300 hover:bg-slate-800'}`}
                                                        >
                                                            <Icon name="Clock" size={12} /> 时长
                                                        </button>
                                                    )}
                                                    {(showAll || hasCalories) && (
                                                        <button
                                                            onClick={() => updateSportConfig(type, 'metric', DataMetric.CALORIES)}
                                                            className={`flex-1 flex items-center justify-center gap-1 py-1.5 rounded text-[10px] font-medium transition-all ${config.metric === DataMetric.CALORIES ? 'bg-secondary/10 text-secondary border border-secondary/50' : 'text-slate-500 hover:text-slate-300 hover:bg-slate-800'}`}
                                                        >
                                                            <Icon name="Flame" size={12} /> 热量
                                                        </button>
                                                    )}
                                                    {(showAll || hasSteps) && (
                                                        <button
                                                            onClick={() => updateSportConfig(type, 'metric', DataMetric.STEPS)}
                                                            className={`flex-1 flex items-center justify-center gap-1 py-1.5 rounded text-[10px] font-medium transition-all ${config.metric === DataMetric.STEPS ? 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/50' : 'text-slate-500 hover:text-slate-300 hover:bg-slate-800'}`}
                                                        >
                                                            <Icon name="Activity" size={12} /> 步数
                                                        </button>
                                                    )}
                                                    {/* 新增 距离 按钮 */}
                                                    {(showAll || hasDistance) && (
                                                        <button
                                                            onClick={() => updateSportConfig(type, 'metric', DataMetric.DISTANCE)}
                                                            className={`flex-1 flex items-center justify-center gap-1 py-1.5 rounded text-[10px] font-medium transition-all ${config.metric === DataMetric.DISTANCE ? 'bg-purple-500/20 text-purple-400 border border-purple-500/50' : 'text-slate-500 hover:text-slate-300 hover:bg-slate-800'}`}
                                                        >
                                                            <Icon name="MapPin" size={12} /> 距离
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        };

        const WorkoutHistory = ({ workouts, onSelect, selectedId }) => {
            if (workouts.length === 0) return <div className="text-center py-10 text-slate-500"><p>No workouts recorded yet.</p></div>;
            return (
                <div className="space-y-3">
                    {workouts.map((w) => (
                        <div key={w.id} onClick={() => onSelect(w)} className={`p-4 rounded-xl border cursor-pointer transition-all hover:translate-x-1 ${selectedId === w.id ? 'bg-slate-800 border-primary' : 'bg-dark border-slate-800 hover:border-slate-600'}`}>
                            <div className="flex justify-between items-start mb-2">
                                <h3 className="font-bold text-white">{w.type}</h3>
                                <span className="text-xs text-slate-400 bg-slate-900 px-2 py-1 rounded">{new Date(w.date).toLocaleDateString()}</span>
                            </div>
                            <div className="flex gap-4 text-xs text-slate-400">
                                <div className="flex items-center gap-1"><Icon name="Clock" size={12} /> {w.duration}m</div>
                                <div className="flex items-center gap-1"><Icon name="Flame" size={12} /> {w.calories} kcal</div>
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        // --- 壁纸生成器 ---
        const PosterGenerator = ({ workouts, goals, visualSettings, sportConfigs, onVisualSettingsChange }) => {
            const [insight, setInsight] = useState(() => workouts.length > 0 ? generatePosterInsight(workouts) : null);

            // 1. 用户图片 (User Image) 比较大，我们单独在组件内部处理它的持久化
            const [userImage, setUserImage] = useState(null); 

            // 2. 从 visualSettings 中解构所有设置 (新增 imageSize 和 imageShape)
            // 如果旧的缓存中没有这些字段，给予默认值
            const { style, imageSize = 300, imageShape = 'circle' } = visualSettings;
            
            const canvasRef = useRef(null);
            const fileInputRef = useRef(null); 

            // --- 尝试持久化保存用户图片 ---
            useEffect(() => {
                const savedImage = localStorage.getItem('fitposter_user_image');
                if (savedImage) setUserImage(savedImage);
            }, []);

            useEffect(() => {
                if (userImage) {
                    try {
                        localStorage.setItem('fitposter_user_image', userImage);
                    } catch (e) {
                        console.warn("图片太大，无法保存到本地缓存", e);
                    }
                } else {
                    // 如果用户移除了图片，也清除缓存
                    localStorage.removeItem('fitposter_user_image');
                }
            }, [userImage]);

            const stats = {
                totalWorkouts: workouts.length,
                totalCalories: workouts.reduce((acc, curr) => acc + (curr.calories || 0), 0),
                totalDuration: workouts.reduce((acc, curr) => acc + (curr.duration || 0), 0),
                // 壁纸生成器也需要计算总步数
                totalSteps: workouts.reduce((acc, curr) => acc + (curr.num || 0), 0),
            };

            const handleGenerate = () => {
                if (workouts.length === 0) { alert("Please log a workout first."); return; }
                setInsight(generatePosterInsight(workouts));
            };

            // 处理图片上传
            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (evt) => setUserImage(evt.target.result);
                    reader.readAsDataURL(file);
                }
            };

            // 核心绘图逻辑 (监听 userImage 变化)
            useEffect(() => {
                if (!canvasRef.current || workouts.length === 0) return;
                
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                // 设置高清画布尺寸
                canvas.width = 3840; 
                canvas.height = 2160;
                const W = canvas.width; 
                const H = canvas.height;

                // 定义绘制某一帧的函数
                const renderFrame = (imgObj) => {
                    // --- 1. 绘制背景 ---
                    ctx.clearRect(0, 0, W, H);
                    if (style === PosterStyle.CYBERPUNK) {
                        const grad = ctx.createLinearGradient(0, 0, W, H);
                        grad.addColorStop(0, '#0f172a'); grad.addColorStop(0.5, '#1e1b4b'); grad.addColorStop(1, '#312e81');
                        ctx.fillStyle = grad; ctx.fillRect(0, 0, W, H);
                        ctx.strokeStyle = 'rgba(0, 212, 255, 0.1)'; ctx.lineWidth = 2;
                        for (let y = H / 2; y < H; y += 40) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke(); }
                        for (let x = 0; x < W; x += 200) { ctx.beginPath(); ctx.moveTo(x, H/2); ctx.lineTo(x - (x-W/2), H); ctx.stroke(); }
                    } else if (style === PosterStyle.NATURE) {
                        const grad = ctx.createLinearGradient(0, 0, 0, H);
                        grad.addColorStop(0, '#022c22'); grad.addColorStop(1, '#064e3b');
                        ctx.fillStyle = grad; ctx.fillRect(0, 0, W, H);
                        for(let i=0; i<20; i++) {
                            ctx.beginPath(); ctx.arc(Math.random() * W, Math.random() * H, Math.random() * 300 + 50, 0, Math.PI*2);
                            ctx.fillStyle = `rgba(34, 197, 94, ${Math.random() * 0.1})`; ctx.fill();
                        }
                    } else if (style === PosterStyle.HEATMAP) {
                        const grad = ctx.createRadialGradient(W/2, H/2, 100, W/2, H/2, W);
                        grad.addColorStop(0, '#be123c'); grad.addColorStop(1, '#4c0519');
                        ctx.fillStyle = grad; ctx.fillRect(0, 0, W, H);
                    } else {
                        ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);
                        ctx.strokeStyle = '#e2e8f0'; ctx.lineWidth = 10;
                        ctx.beginPath(); ctx.arc(W/2, H/2, 600, 0, Math.PI*2); ctx.stroke();
                    }

                    // 遮罩层
                    if (style !== PosterStyle.MINIMALIST) {
                        const g = ctx.createLinearGradient(0, 0, 0, H);
                        g.addColorStop(0, "rgba(15, 23, 42, 0.2)"); g.addColorStop(1, "rgba(15, 23, 42, 0.9)");
                        ctx.fillStyle = g; ctx.fillRect(0, 0, W, H);
                    }

                    // 颜色定义
                    let mainColor = '#00D4FF'; let secColor = '#FF0055'; let textColor = 'rgba(255,255,255,0.8)';
                    if (style === PosterStyle.NATURE) { mainColor = '#4ade80'; secColor = '#facc15'; }
                    if (style === PosterStyle.HEATMAP) { mainColor = '#f43f5e'; secColor = '#fb923c'; }
                    if (style === PosterStyle.MINIMALIST) { mainColor = '#0f172a'; secColor = '#334155'; textColor = '#334155'; }


                    // --- 2. 绘制上方固定区域 (Header Area) ---
                    // 整体高度区域: Y 0 - 650
                    
                    // A. 左上角：数据统计 (Top Left) - 2x2 网格布局
                    // 坐标原点
                    const statsOriginX = 120;
                    const statsOriginY = 160;
                    // 网格间距
                    const colGap = 400; // 列宽
                    const rowGap = 160; // 行高

                    ctx.textAlign = "left";
                    
                    const drawGridStat = (label, val, col, row) => {
                         const x = statsOriginX + col * colGap;
                         const y = statsOriginY + row * rowGap;
                         
                         // Label
                         ctx.font = "bold 28px Inter"; 
                         ctx.fillStyle = style === PosterStyle.MINIMALIST ? '#64748b' : "rgba(255,255,255,0.4)"; 
                         ctx.fillText(label, x, y);
                         // Value
                         ctx.font = "bold 70px Inter"; 
                         ctx.fillStyle = style === PosterStyle.MINIMALIST ? '#0f172a' : "#ffffff"; 
                         ctx.fillText(val, x, y + 70);
                    };

                    // (0, 0)
                    drawGridStat("总运动次数", `${stats.totalWorkouts}`, 0, 0);
                    // (1, 0)
                    drawGridStat("总步数", `${stats.totalSteps.toLocaleString()}`, 1, 0);
                    // (0, 1)
                    drawGridStat("消耗热量 (Kcal)", `${stats.totalCalories.toLocaleString()}`, 0, 1);
                    // (1, 1)
                    drawGridStat("运动时长 (Min)", `${stats.totalDuration}`, 1, 1);


                    // B. 中间：标题与语录 (Center)
                    // 为避免与左侧 Grid 冲突，CenterX 稍微向右偏移一点，或者保持绝对居中
                    ctx.textAlign = "center";
                    const centerX = W / 2 + 100; // 稍微右移，平衡左侧较宽的统计区
                    
                    // 标题
                    ctx.font = "bold 70px Inter"; 
                    ctx.fillStyle = style === PosterStyle.MINIMALIST ? '#0f172a' : "#ffffff";
                    ctx.fillText(goals?.title || "", centerX, 200);

                    // 副标题
                    ctx.font = "500 50px Inter"; 
                    ctx.fillStyle = textColor; 
                    ctx.fillText(goals?.subtitle || "", centerX, 290);
                    
                    // 语录
                    ctx.font = "italic 400 40px Inter"; 
                    ctx.fillStyle = style === PosterStyle.MINIMALIST ? '#64748b' : "rgba(255,255,255,0.7)";
                    if (insight) ctx.fillText(`“ ${insight} ”`, centerX, 420);


                    // C. 右上角：用户图片 (Top Right)
                    if (imgObj) {
                        const size = imageSize; 
                        const margin = 120;
                        const x = W - size - margin;
                        const y = margin;
                        
                        ctx.save();
                        ctx.shadowColor = "rgba(0,0,0,0.3)";
                        ctx.shadowBlur = 20;
                        ctx.shadowOffsetX = 0;
                        ctx.shadowOffsetY = 10;

                        if (imageShape === 'circle') {
                            ctx.beginPath(); ctx.arc(x + size/2, y + size/2, size/2, 0, Math.PI * 2); ctx.closePath(); ctx.clip();
                            ctx.drawImage(imgObj, x, y, size, size);
                            ctx.restore(); 
                            ctx.beginPath(); ctx.arc(x + size/2, y + size/2, size/2, 0, Math.PI * 2);
                            ctx.lineWidth = 10; ctx.strokeStyle = '#fff'; ctx.stroke();
                        } else {
                            const aspectRatio = imgObj.width / imgObj.height;
                            const drawW = size;
                            const drawH = size / aspectRatio;
                            ctx.drawImage(imgObj, x, y, drawW, drawH);
                            ctx.restore(); 
                            ctx.lineWidth = 10; ctx.strokeStyle = '#fff'; 
                            ctx.strokeRect(x, y, drawW, drawH);
                        }
                    }

                    // --- 3. 绘制图表区域 (Charts Area - Auto Centered Row) ---
                    // 区域定义: Y: 680 - 2060
                    const chartAreaTop = 680;
                    const chartAreaBottom = 2060;
                    const chartTotalHeight = chartAreaBottom - chartAreaTop;
                    
                    const GRID_ROWS = 2; 
                    const maxColsInLayout = 3; // 布局基准是3列
                    const sideMargin = 150;
                    const gapX = 150;
                    const gapY = 100;

                    // 计算单个单元格的标准宽度 (用于绘图尺寸)
                    const cellWidth = (W - sideMargin * 2 - (gapX * (maxColsInLayout - 1))) / maxColsInLayout;
                    const cellHeight = (chartTotalHeight - (gapY * (GRID_ROWS - 1))) / GRID_ROWS;

                    const workoutsByType = {};
                    workouts.forEach(w => {
                        if (!workoutsByType[w.type]) workoutsByType[w.type] = [];
                        workoutsByType[w.type].push(w);
                    });
                    
                    const uniqueTypes = Object.keys(workoutsByType).filter(type => type !== 'Swimming' && type !== '游泳');
                    const chartColorPalette = [mainColor, secColor, style === PosterStyle.NATURE ? '#22d3ee' : '#fcd34d', '#a78bfa', '#f472b6', '#34d399'];

                    // --- 新逻辑：按行分组，计算居中 ---
                    
                    // 1. 准备数据对象
                    const chartObjects = uniqueTypes.map(type => {
                        const config = sportConfigs[type] || {};
                        let row = config.row || 1;
                        let col = config.col || 1;
                        // 边界保护
                        if(row < 1) row = 1; if(row > 2) row = 2;
                        return { type, row, col };
                    });

                    // 2. 按行分组
                    const rows = { 1: [], 2: [] };
                    chartObjects.forEach(obj => rows[obj.row].push(obj));

                    // 3. 逐行绘制
                    [1, 2].forEach(rowIndex => {
                        const chartsInRow = rows[rowIndex];
                        if (chartsInRow.length === 0) return;

                        // 按 col 排序，保证用户指定的相对顺序
                        chartsInRow.sort((a, b) => a.col - b.col);

                        // 计算当前行内容的实际总宽度
                        const count = chartsInRow.length;
                        const rowContentWidth = count * cellWidth + (count - 1) * gapX;

                        // 计算起始 X，使其居中
                        // W/2 - content/2 = startX
                        const rowStartX = (W - rowContentWidth) / 2;
                        
                        const currentChartY = chartAreaTop + (rowIndex - 1) * (cellHeight + gapY);
                        const chartTitleAreaH = 100;
                        const chartDrawH = cellHeight - chartTitleAreaH - 40;
                        const chartPlotY = currentChartY + chartTitleAreaH;

                        chartsInRow.forEach((chartObj, i) => {
                            const type = chartObj.type;
                            // 动态计算X: 起始点 + 偏移量
                            const currentChartX = rowStartX + i * (cellWidth + gapX);

                            const typeData = workoutsByType[type]
                                    .sort((a, b) => (a.id || "").localeCompare(b.id || ""))
                                    .slice(-15);

                            const metricConfig = sportConfigs[type] || { mode: ChartMode.CURVE, metric: DataMetric.DURATION };
                            let metricKey = 'duration';
                            if (metricConfig.metric === DataMetric.CALORIES) metricKey = 'calories';
                            if (metricConfig.metric === DataMetric.STEPS) metricKey = 'num';
                            if (metricConfig.metric === DataMetric.DISTANCE) metricKey = 'distance';

                            const currentColor = chartColorPalette[((rowIndex - 1) * 3 + i) % chartColorPalette.length];

                            // --- 绘图逻辑 (复用) ---

                            // 1. 标题 (在 Cell 顶部居中)
                            const titleCenterY = currentChartY + chartTitleAreaH / 2;
                            const titleCenterX = currentChartX + cellWidth / 2;
                            
                            ctx.fillStyle = textColor; 
                            ctx.font = "bold 40px Inter"; 
                            ctx.textAlign = "center";
                            const sportMap = { 'Badminton': '羽毛球', 'Running': '跑步', 'Swimming': '游泳', 'Cycling': '骑行', 'Walking': '徒步', 'Yoga': '瑜伽', 'Gym': '健身', 'HIIT': '高强度间歇', 'Pilates': '普拉提' };
                            
                            ctx.fillText(sportMap[type] || type, titleCenterX, titleCenterY - 15);
                            
                            ctx.font = "400 24px Inter";
                            ctx.fillStyle = style === PosterStyle.MINIMALIST ? '#94a3b8' : 'rgba(255,255,255,0.5)';
                            let subLabel = '运动时长';
                            if (metricConfig.metric === DataMetric.CALORIES) subLabel = '热量消耗';
                            if (metricConfig.metric === DataMetric.STEPS) subLabel = '行走步数';
                            if (metricConfig.metric === DataMetric.DISTANCE) subLabel = '运动距离 (km)';
                            ctx.fillText(`(${subLabel})`, titleCenterX, titleCenterY + 25);

                            // 2. 坐标轴横线
                            ctx.strokeStyle = style === PosterStyle.MINIMALIST ? '#cbd5e1' : 'rgba(255,255,255,0.2)'; 
                            ctx.lineWidth = 2;
                            ctx.beginPath(); ctx.moveTo(currentChartX, chartPlotY + chartDrawH); ctx.lineTo(currentChartX + cellWidth, chartPlotY + chartDrawH); ctx.stroke();

                            // 3. 计算数据
                            let rawMax = Math.max(...typeData.map(w => w[metricKey] || 0));
                            if (metricKey === 'num') rawMax = Math.max(rawMax, 10000);
                            const maxVal = rawMax * 1.2 || 60; 

                            // 4. Y轴刻度
                            const numTicks = 5; 
                            ctx.textAlign = "right"; ctx.textBaseline = "middle"; 
                            ctx.font = "bold 20px Inter"; 
                            ctx.fillStyle = style === PosterStyle.MINIMALIST ? '#94a3b8' : 'rgba(255,255,255,0.4)';
                            ctx.save();
                            for (let t = 0; t <= numTicks; t++) {
                                const tickY = chartPlotY + chartDrawH - (chartDrawH * (t / numTicks));
                                const tickVal = Math.round(maxVal * (t / numTicks));
                                if (t > 0) ctx.fillText(`${tickVal}`, currentChartX - 10, tickY);
                                if (t > 0) { 
                                    ctx.beginPath(); ctx.lineWidth = 1;
                                    ctx.strokeStyle = style === PosterStyle.MINIMALIST ? 'rgba(0,0,0,0.05)' : 'rgba(255,255,255,0.05)';
                                    ctx.moveTo(currentChartX, tickY); ctx.lineTo(currentChartX + cellWidth, tickY); ctx.stroke();
                                }
                            }
                            ctx.restore();

                            // 5. 10k 目标线
                            if (metricKey === 'num') {
                                const goalVal = 10000;
                                const goalY = chartPlotY + chartDrawH - ((goalVal / maxVal) * chartDrawH);
                                ctx.save();
                                ctx.beginPath();
                                ctx.strokeStyle = '#2DD4BF'; ctx.lineWidth = 2; ctx.setLineDash([6, 4]); 
                                ctx.moveTo(currentChartX, goalY); ctx.lineTo(currentChartX + cellWidth, goalY);
                                ctx.shadowColor = "#2DD4BF"; ctx.shadowBlur = 10; ctx.stroke(); ctx.shadowBlur = 0; 
                                ctx.fillStyle = '#2DD4BF'; ctx.font = "bold 20px Inter"; 
                                ctx.textAlign = "right"; ctx.textBaseline = "bottom";
                                ctx.fillText("10k", currentChartX + cellWidth, goalY - 8);
                                ctx.restore();
                            }

                            // 6. 绘图
                            const stepX = cellWidth / (typeData.length || 1);
                            
                            if (metricConfig.mode === ChartMode.BAR) {
                                typeData.forEach((d, i) => {
                                    const val = d[metricKey] || 0; 
                                    const h = (val/maxVal) * chartDrawH;
                                    const x = currentChartX + (i * stepX) + stepX * 0.1; const y = chartPlotY + chartDrawH - h; const bw = stepX * 0.8;
                                    ctx.fillStyle = currentColor; ctx.beginPath(); ctx.roundRect(x, y, bw, h, [15,15,0,0]); ctx.fill();
                                    if (typeData.length < 8) { 
                                        ctx.fillStyle = textColor; ctx.font = "bold 20px Inter"; ctx.textAlign = "center"; ctx.fillText(val, x + bw/2, y - 10);
                                    }
                                });
                            } else {
                                ctx.beginPath();
                                typeData.forEach((d, i) => {
                                    const val = d[metricKey] || 0; 
                                    const x = currentChartX + (i * stepX) + stepX/2; const y = chartPlotY + chartDrawH - ((val / maxVal) * chartDrawH);
                                    if (i === 0) ctx.moveTo(x, y);
                                    else {
                                        if (metricConfig.mode === ChartMode.CURVE) {
                                            const prevVal = typeData[i-1][metricKey] || 0; 
                                            const prevX = currentChartX + ((i-1) * stepX) + stepX/2; const prevY = chartPlotY + chartDrawH - ((prevVal / maxVal) * chartDrawH);
                                            ctx.bezierCurveTo(prevX + (x-prevX)/2, prevY, prevX + (x-prevX)/2, y, x, y);
                                        } else { ctx.lineTo(x, y); }
                                    }
                                });
                                ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.lineWidth = 8; ctx.strokeStyle = currentColor;
                                if (style !== PosterStyle.MINIMALIST) { ctx.shadowColor = currentColor; ctx.shadowBlur = 20; }
                                ctx.stroke(); ctx.shadowBlur = 0;
                                typeData.forEach((d, i) => {
                                    const val = d[metricKey] || 0; 
                                    const x = currentChartX + (i * stepX) + stepX/2; const y = chartPlotY + chartDrawH - ((val / maxVal) * chartDrawH);
                                    ctx.beginPath(); ctx.arc(x, y, 6, 0, Math.PI*2); ctx.fillStyle = style === PosterStyle.MINIMALIST ? currentColor : "#fff"; ctx.fill();
                                });
                            }

                            // 7. 日期
                            if (typeData.length > 0) {
                                ctx.font = "bold 18px Inter"; ctx.fillStyle = style === PosterStyle.MINIMALIST ? '#64748b' : 'rgba(255,255,255,0.6)'; ctx.textAlign = "center";
                                const skipRate = typeData.length > 10 ? 2 : 1;
                                typeData.forEach((d, i) => {
                                    if (i % skipRate !== 0) return;
                                    const centerX = currentChartX + (i * stepX) + stepX / 2;
                                    let dateStr = "";
                                    if (d.id && typeof d.id === 'string') {
                                        const parts = d.id.split('-'); 
                                        if (parts.length >= 3) { dateStr = `${parseInt(parts[1])}/${parseInt(parts[2])}`; }
                                    }
                                    ctx.fillText(dateStr, centerX, chartPlotY + chartDrawH + 40);
                                });
                            }
                        });
                    });
                };

                //     // --- 3. 绘制图表区域 (Charts Area - Auto Centered Row) ---
                //     // 区域定义: Y: 680 - 2060
                //     const chartAreaTop = 680;
                //     const chartAreaBottom = 2060;
                //     const chartTotalHeight = chartAreaBottom - chartAreaTop;
                    
                //     // 定义 2x3 网格参数
                //     const GRID_ROWS = 2;
                //     const GRID_COLS = 3;
                //     const sideMargin = 150;
                //     const gapX = 150;
                //     const gapY = 100;

                //     // 计算单个单元格的大小
                //     const cellWidth = (W - sideMargin * 2 - (gapX * (GRID_COLS - 1))) / GRID_COLS;
                //     const cellHeight = (chartTotalHeight - (gapY * (GRID_ROWS - 1))) / GRID_ROWS;

                //     const workoutsByType = {};
                //     workouts.forEach(w => {
                //         if (!workoutsByType[w.type]) workoutsByType[w.type] = [];
                //         workoutsByType[w.type].push(w);
                //     });

                //     const uniqueTypes = Object.keys(workoutsByType).filter(type => type !== 'Swimming' && type !== '游泳');
                //     const chartColorPalette = [mainColor, secColor, style === PosterStyle.NATURE ? '#22d3ee' : '#fcd34d', '#a78bfa', '#f472b6', '#34d399'];

                //     uniqueTypes.forEach((type, index) => {
                //         const config = sportConfigs[type] || {};
                        
                //         // 获取用户配置的行列，如果没有则使用默认逻辑 (fallback)
                //         // 强制限制在 Row 1-2, Col 1-3
                //         let targetRow = (config.row || 1); 
                //         let targetCol = (config.col || 1);
                        
                //         // 简单的边界检查
                //         if (targetRow < 1) targetRow = 1; if (targetRow > 2) targetRow = 2;
                //         if (targetCol < 1) targetCol = 1; if (targetCol > 3) targetCol = 3;

                //         // 转换为索引 (0-based)
                //         const rowIndex = targetRow - 1;
                //         const colIndex = targetCol - 1;

                //         const typeData = workoutsByType[type]
                //                 .sort((a, b) => (a.id || "").localeCompare(b.id || ""))
                //                 .slice(-15);
                        
                //         // 计算该图表的实际绘制区域
                //         const currentChartX = sideMargin + colIndex * (cellWidth + gapX);
                //         const currentChartY = chartAreaTop + rowIndex * (cellHeight + gapY);
                        
                //         // 内部留白
                //         const chartTitleAreaH = 100;
                //         const chartDrawH = cellHeight - chartTitleAreaH - 40; // 绘图区高度
                //         const chartPlotY = currentChartY + chartTitleAreaH;

                //         // 复用绘图逻辑 ...
                //         const metricConfig = sportConfigs[type] || { mode: ChartMode.CURVE, metric: DataMetric.DURATION };
                //         let metricKey = 'duration';
                //         if (metricConfig.metric === DataMetric.CALORIES) metricKey = 'calories';
                //         if (metricConfig.metric === DataMetric.STEPS) metricKey = 'num';

                //         const currentColor = chartColorPalette[(rowIndex * 3 + colIndex) % chartColorPalette.length];

                //         // 1. 标题 (在 Cell 顶部居中)
                //         const titleCenterY = currentChartY + chartTitleAreaH / 2;
                //         const titleCenterX = currentChartX + cellWidth / 2;
                        
                //         ctx.fillStyle = textColor; 
                //         ctx.font = "bold 40px Inter"; 
                //         ctx.textAlign = "center";
                //         const sportMap = { 'Badminton': '羽毛球', 'Running': '跑步', 'Swimming': '游泳', 'Cycling': '骑行', 'Walking': '徒步', 'Yoga': '瑜伽', 'Gym': '健身', 'HIIT': '高强度间歇', 'Pilates': '普拉提' };
                        
                //         ctx.fillText(sportMap[type] || type, titleCenterX, titleCenterY - 15);
                        
                //         ctx.font = "400 24px Inter";
                //         ctx.fillStyle = style === PosterStyle.MINIMALIST ? '#94a3b8' : 'rgba(255,255,255,0.5)';
                //         let subLabel = '运动时长';
                //         if (metricConfig.metric === DataMetric.CALORIES) subLabel = '热量消耗';
                //         if (metricConfig.metric === DataMetric.STEPS) subLabel = '行走步数';
                //         ctx.fillText(`(${subLabel})`, titleCenterX, titleCenterY + 25);

                //         // 2. 坐标轴横线
                //         ctx.strokeStyle = style === PosterStyle.MINIMALIST ? '#cbd5e1' : 'rgba(255,255,255,0.2)'; 
                //         ctx.lineWidth = 2;
                //         ctx.beginPath(); ctx.moveTo(currentChartX, chartPlotY + chartDrawH); ctx.lineTo(currentChartX + cellWidth, chartPlotY + chartDrawH); ctx.stroke();

                //         // 3. 计算数据
                //         let rawMax = Math.max(...typeData.map(w => w[metricKey] || 0));
                //         if (metricKey === 'num') rawMax = Math.max(rawMax, 10000);
                //         const maxVal = rawMax * 1.2 || 60; 

                //         // 4. Y轴刻度
                //         const numTicks = 5; 
                //         ctx.textAlign = "right"; ctx.textBaseline = "middle"; 
                //         ctx.font = "bold 20px Inter"; 
                //         ctx.fillStyle = style === PosterStyle.MINIMALIST ? '#94a3b8' : 'rgba(255,255,255,0.4)';
                //         ctx.save();
                //         for (let t = 0; t <= numTicks; t++) {
                //             const tickY = chartPlotY + chartDrawH - (chartDrawH * (t / numTicks));
                //             const tickVal = Math.round(maxVal * (t / numTicks));
                //             if (t > 0) ctx.fillText(`${tickVal}`, currentChartX - 10, tickY);
                //             if (t > 0) { 
                //                 ctx.beginPath(); ctx.lineWidth = 1;
                //                 ctx.strokeStyle = style === PosterStyle.MINIMALIST ? 'rgba(0,0,0,0.05)' : 'rgba(255,255,255,0.05)';
                //                 ctx.moveTo(currentChartX, tickY); ctx.lineTo(currentChartX + cellWidth, tickY); ctx.stroke();
                //             }
                //         }
                //         ctx.restore();

                //         // 5. 10k 目标线
                //         if (metricKey === 'num') {
                //             const goalVal = 10000;
                //             const goalY = chartPlotY + chartDrawH - ((goalVal / maxVal) * chartDrawH);
                //             ctx.save();
                //             ctx.beginPath();
                //             ctx.strokeStyle = '#2DD4BF'; ctx.lineWidth = 2; ctx.setLineDash([6, 4]); 
                //             ctx.moveTo(currentChartX, goalY); ctx.lineTo(currentChartX + cellWidth, goalY);
                //             ctx.shadowColor = "#2DD4BF"; ctx.shadowBlur = 10; ctx.stroke(); ctx.shadowBlur = 0; 
                //             ctx.fillStyle = '#2DD4BF'; ctx.font = "bold 20px Inter"; 
                //             ctx.textAlign = "right"; ctx.textBaseline = "bottom";
                //             ctx.fillText("10k", currentChartX + cellWidth, goalY - 8);
                //             ctx.restore();
                //         }

                //         // 6. 绘图
                //         const stepX = cellWidth / (typeData.length || 1);
                        
                //         if (metricConfig.mode === ChartMode.BAR) {
                //             typeData.forEach((d, i) => {
                //                 const val = d[metricKey] || 0; 
                //                 const h = (val/maxVal) * chartDrawH;
                //                 const x = currentChartX + (i * stepX) + stepX * 0.1; const y = chartPlotY + chartDrawH - h; const bw = stepX * 0.8;
                //                 ctx.fillStyle = currentColor; ctx.beginPath(); ctx.roundRect(x, y, bw, h, [15,15,0,0]); ctx.fill();
                //                 if (typeData.length < 8) { 
                //                     ctx.fillStyle = textColor; ctx.font = "bold 20px Inter"; ctx.textAlign = "center"; ctx.fillText(val, x + bw/2, y - 10);
                //                 }
                //             });
                //         } else {
                //             ctx.beginPath();
                //             typeData.forEach((d, i) => {
                //                 const val = d[metricKey] || 0; 
                //                 const x = currentChartX + (i * stepX) + stepX/2; const y = chartPlotY + chartDrawH - ((val / maxVal) * chartDrawH);
                //                 if (i === 0) ctx.moveTo(x, y);
                //                 else {
                //                     if (metricConfig.mode === ChartMode.CURVE) {
                //                         const prevVal = typeData[i-1][metricKey] || 0; 
                //                         const prevX = currentChartX + ((i-1) * stepX) + stepX/2; const prevY = chartPlotY + chartDrawH - ((prevVal / maxVal) * chartDrawH);
                //                         ctx.bezierCurveTo(prevX + (x-prevX)/2, prevY, prevX + (x-prevX)/2, y, x, y);
                //                     } else { ctx.lineTo(x, y); }
                //                 }
                //             });
                //             ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.lineWidth = 8; ctx.strokeStyle = currentColor;
                //             if (style !== PosterStyle.MINIMALIST) { ctx.shadowColor = currentColor; ctx.shadowBlur = 20; }
                //             ctx.stroke(); ctx.shadowBlur = 0;
                //             typeData.forEach((d, i) => {
                //                 const val = d[metricKey] || 0; 
                //                 const x = currentChartX + (i * stepX) + stepX/2; const y = chartPlotY + chartDrawH - ((val / maxVal) * chartDrawH);
                //                 ctx.beginPath(); ctx.arc(x, y, 6, 0, Math.PI*2); ctx.fillStyle = style === PosterStyle.MINIMALIST ? currentColor : "#fff"; ctx.fill();
                //             });
                //         }

                //         // 7. 日期
                //         if (typeData.length > 0) {
                //             ctx.font = "bold 18px Inter"; ctx.fillStyle = style === PosterStyle.MINIMALIST ? '#64748b' : 'rgba(255,255,255,0.6)'; ctx.textAlign = "center";
                //             const skipRate = typeData.length > 10 ? 2 : 1;
                //             typeData.forEach((d, i) => {
                //                 if (i % skipRate !== 0) return;
                //                 const centerX = currentChartX + (i * stepX) + stepX / 2;
                //                 let dateStr = "";
                //                 if (d.id && typeof d.id === 'string') {
                //                     const parts = d.id.split('-'); 
                //                     if (parts.length >= 3) { dateStr = `${parseInt(parts[1])}/${parseInt(parts[2])}`; }
                //                 }
                //                 ctx.fillText(dateStr, centerX, chartPlotY + chartDrawH + 40);
                //             });
                //         }
                //     });
                // };

                // 处理图片加载逻辑
                if (userImage) {
                    const img = new Image();
                    img.src = userImage;
                    img.onload = () => renderFrame(img);
                } else {
                    renderFrame(null);
                }

            }, [insight, workouts, goals, visualSettings, sportConfigs, userImage]); // 依赖项更新

            const downloadPoster = () => {
                const link = document.createElement('a');
                link.download = `fitposter-${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvasRef.current.toDataURL('image/png');
                link.click();
            };

            return (
                <div className="bg-card/50 flex flex-col h-full w-full overflow-hidden relative">
                    <div className="px-6 py-4 flex flex-col xl:flex-row xl:items-center justify-between gap-4 shrink-0 bg-card border-b border-slate-800 z-10 shadow-sm">
                        <div>
                            <h2 className="text-xl font-bold text-white mb-1 flex items-center gap-2">
                                <Icon name="Sparkles" className="text-secondary" /> Wallpaper Generator
                            </h2>
                            <p className="text-slate-400 text-sm">Separated Charts by Sport Type</p>
                        </div>
                        
                        <div className="flex flex-wrap items-center gap-4">
                            <input type="file" ref={fileInputRef} onChange={handleImageUpload} className="hidden" accept="image/*" />
                            <div className="flex items-center mr-2">
                                {userImage ? (
                                    <div className="flex items-center gap-3">
                                        <button 
                                            onClick={() => setUserImage(null)} 
                                            className="flex items-center gap-2 px-3 py-1.5 rounded-md text-xs font-medium bg-red-500/10 text-red-400 border border-red-500/50 hover:bg-red-500/20 transition-colors"
                                        >
                                            <Icon name="Trash2" size={14} /> 移除
                                        </button>

                                        {/* 更新 imageShape 到 visualSettings */}
                                        <button 
                                            onClick={() => onVisualSettingsChange({
                                                ...visualSettings, 
                                                imageShape: imageShape === 'circle' ? 'original' : 'circle'
                                            })}
                                            className="flex items-center gap-2 px-3 py-1.5 rounded-md text-xs font-medium bg-dark border border-slate-700 text-slate-300 hover:text-white hover:border-primary transition-colors"
                                            title="切换形状: 圆形 / 原图"
                                        >
                                            {imageShape === 'circle' ? (
                                                <><div className="w-3 h-3 rounded-full border-2 border-current"></div> 圆形</>
                                            ) : (
                                                <><div className="w-3 h-3 border-2 border-current"></div> 原图</>
                                            )}
                                        </button>

                                        {/* 更新 imageSize 到 visualSettings */}
                                        <div className="flex items-center gap-2 bg-dark/50 px-3 py-1 rounded-md border border-slate-700 h-[34px]">
                                            <span className="text-[10px] text-slate-400 font-medium">Size</span>
                                            <input 
                                                type="range" 
                                                min="150" 
                                                max="800" 
                                                step="10"
                                                value={imageSize} 
                                                onChange={(e) => onVisualSettingsChange({
                                                    ...visualSettings,
                                                    imageSize: Number(e.target.value)
                                                })}
                                                className="w-24 h-1 bg-slate-600 rounded-lg appearance-none cursor-pointer accent-primary hover:accent-cyan-300"
                                                title="调整图片大小"
                                            />
                                        </div>
                                    </div>
                                ) : (
                                    <button 
                                        onClick={() => fileInputRef.current.click()} 
                                        className="flex items-center gap-2 px-3 py-1.5 rounded-md text-xs font-medium bg-dark border border-slate-700 text-slate-300 hover:text-white hover:border-primary hover:bg-primary/10 transition-all"
                                    >
                                        <Icon name="ImagePlus" size={16} /> 插入图片
                                    </button>
                                )}
                            </div>

                            <div className="h-6 w-px bg-slate-700 mx-2"></div>

                            {/* 布局选择器 */}
                            <div className="flex bg-dark/50 rounded-lg p-1 border border-slate-700 mr-2">
                                {[
                                    { id: LayoutMode.ROW, icon: <div className="flex gap-0.5"><div className="w-1 h-3 bg-current rounded-sm"></div><div className="w-1 h-3 bg-current rounded-sm"></div><div className="w-1 h-3 bg-current rounded-sm"></div></div>, title: "Standard Row (3)" },
                                    { id: LayoutMode.GRID, icon: <div className="grid grid-cols-2 gap-0.5"><div className="w-1 h-1 bg-current rounded-sm"></div><div className="w-1 h-1 bg-current rounded-sm"></div><div className="w-1 h-1 bg-current rounded-sm"></div><div className="w-1 h-1 bg-current rounded-sm"></div></div>, title: "Grid View (6)" },
                                    { id: LayoutMode.FOCUS, icon: <div className="w-3 h-3 border-2 border-current rounded-sm"></div>, title: "Single Focus (1)" }
                                ].map(layoutOpt => (
                                    <button
                                        key={layoutOpt.id}
                                        onClick={() => onVisualSettingsChange({ ...visualSettings, layout: layoutOpt.id })}
                                        className={`p-1.5 rounded hover:bg-slate-700 transition-colors ${visualSettings.layout === layoutOpt.id ? 'text-primary bg-slate-800 shadow-sm' : 'text-slate-400'}`}
                                        title={layoutOpt.title}
                                    >
                                        {layoutOpt.icon}
                                    </button>
                                ))}
                            </div>

                            {insight && (
                                <div className="flex gap-2 mr-2 border-r border-slate-700 pr-4">
                                     <Button onClick={downloadPoster} className="px-3 py-1.5 text-xs"><Icon name="Download" size={16} /> 下载 4K</Button>
                                     <Button onClick={handleGenerate} variant="secondary" className="px-3 py-1.5 text-xs"><Icon name="RefreshCw" size={16} /> 重新生成</Button>
                                </div>
                            )}

                            <div className="flex flex-wrap gap-2">
                                <div className="text-xs text-slate-500 flex items-center mr-2">主题风格:</div>
                                {Object.values(PosterStyle).map(s => (
                                    <button key={s} onClick={() => onVisualSettingsChange({...visualSettings, style: s})} className={`text-xs px-3 py-1.5 rounded-md ${style === s ? 'bg-slate-700 text-white' : 'text-slate-400'}`}>
                                        {s.split(' ')[1] || s}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="flex-1 flex flex-col min-h-0 bg-dark relative p-4">
                        {/* 此处画布内容渲染保持不变 */}
                        {workouts.length === 0 ? (
                            <div className="flex-1 border-2 border-dashed border-slate-700 rounded-xl flex flex-col items-center justify-center bg-dark/30 gap-4 p-8 m-8">
                                <Icon name="Dumbbell" size={48} className="text-slate-600" />
                                <p className="text-slate-400">暂无运动数据，请先在“数据管理”页面录入数据。</p>
                            </div>
                        ) : (
                            <div className="flex-1 flex flex-col min-h-0 fade-in relative">
                                <div className="w-full h-full rounded-xl overflow-hidden shadow-2xl ring-1 ring-slate-700 flex items-center justify-center bg-dark/50">
                                    <canvas ref={canvasRef} className="max-w-full max-h-full object-contain" />
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- 5. 主应用组件 ---
        const App = () => {
            const [workouts, setWorkouts] = useState([]);
            const [view, setView] = useState('log'); 

            // --- 从本地存储加载 Visual Settings (包含主题、图片大小、形状) ---
            const [visualSettings, setVisualSettings] = useState(() => {
                const saved = localStorage.getItem('fitposter_visual_settings');
                return saved ? JSON.parse(saved) : {
                    style: PosterStyle.CYBERPUNK,
                    imageSize: 300,
                    imageShape: 'circle',
                    layout: LayoutMode.ROW // 默认布局
                };
            });


            // --- 自动保存 Visual Settings ---
            useEffect(() => {
                localStorage.setItem('fitposter_visual_settings', JSON.stringify(visualSettings));
            }, [visualSettings]);

            // 目标状态管理
            const [goals, setGoals] = useState({
                title: "2025 年度目标",    // 默认大目标
                subtitle: "自律即自由，坚持每一天" // 默认小目标
            });

            // 持久化 Goals 数据
            useEffect(() => {
                const savedGoals = localStorage.getItem('fitposter_goals');
                if (savedGoals) setGoals(JSON.parse(savedGoals));
            }, []);
            useEffect(() => {
                localStorage.setItem('fitposter_goals', JSON.stringify(goals));
            }, [goals]);

            // --- 从本地存储加载分项运动配置 (sportConfigs) ---
            const [sportConfigs, setSportConfigs] = useState(() => {
                const saved = localStorage.getItem('fitposter_sport_configs');
                return saved ? JSON.parse(saved) : {};
            });

            // --- 自动保存分项运动配置 ---
            useEffect(() => {
                localStorage.setItem('fitposter_sport_configs', JSON.stringify(sportConfigs));
            }, [sportConfigs]);

            useEffect(() => {
                const saved = localStorage.getItem('fitposter_workouts');
                if (saved) setWorkouts(JSON.parse(saved));
            }, []);
            useEffect(() => {
                localStorage.setItem('fitposter_workouts', JSON.stringify(workouts));
            }, [workouts]);

            const handleJsonUpdate = (newData) => {
                setWorkouts(newData);
            };

            return (
                <div className="min-h-screen bg-dark text-slate-200 flex flex-col">
                    <nav className="bg-dark/80 backdrop-blur-md border-b border-slate-800 sticky top-0 z-50 shrink-0">
                         <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2 cursor-pointer" onClick={() => setView('log')}>
                                <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-primary to-secondary flex items-center justify-center">
                                    <Icon name="Dumbbell" className="text-white" size={20} />
                                </div>
                                <span className="font-bold text-xl text-white">FitPoster Local</span>
                            </div>
                            
                            <div className="flex gap-2 bg-card/50 p-1 rounded-lg border border-slate-700">
                                <button 
                                    onClick={() => setView('log')} 
                                    className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all flex items-center gap-2 ${view === 'log' ? 'bg-slate-700 text-white shadow' : 'text-slate-400 hover:text-white'}`}
                                >
                                    <Icon name="Activity" size={16} /> 数据管理
                                </button>
                                <button 
                                    onClick={() => setView('poster')} 
                                    className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all flex items-center gap-2 ${view === 'poster' ? 'bg-primary text-dark shadow font-bold' : 'text-slate-400 hover:text-white'}`}
                                >
                                    <Icon name="Sparkles" size={16} /> 生成壁纸
                                </button>
                            </div>
                        </div>
                    </nav>

                    <main className="flex-1 overflow-hidden flex flex-col">
                        
                        {/* 视图 1: 数据管理 (布局：上下滚动) */}
                        {view === 'log' && (
                            // 1. 容器允许滚动，移除 h-[calc...] 固定高度
                            <div className="flex-1 overflow-y-auto custom-scrollbar bg-dark">
                                <div className="max-w-7xl mx-auto px-4 py-8 space-y-8">
                                    
                                    {/* 上部分：数据概览 (左) + JSON编辑器 (右) */}
                                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                        
                                        <div className="lg:col-span-1">
                                            {/* 传递 goals 和 setGoals 给 DataOverviewPanel */}
                                            <DataOverviewPanel 
                                                workouts={workouts} 
                                                goals={goals} 
                                                onGoalsChange={setGoals} 
                                            />
                                        </div>

                                        {/* 右侧：JSON (占 2/3) */}
                                        {/* 给 JSON 编辑器一个最小高度，确保在数据少时也有足够编辑空间 */}
                                        <div className="lg:col-span-2 min-h-[340px]">
                                            <JsonEditor workouts={workouts} onUpdate={handleJsonUpdate} />
                                        </div>
                                    </div>

                                    {/* 下部分：分项可视化配置 (完全展开) */}
                                    <div>
                                        <VisualConfigPanel 
                                            workouts={workouts} 
                                            sportConfigs={sportConfigs}
                                            onConfigChange={setSportConfigs}
                                        />
                                    </div>

                                    {/* 底部留白，方便滚动到底部 */}
                                    <div className="h-8"></div>
                                </div>
                            </div>
                        )}

                        {/* 视图 2: 壁纸预览 */}
                        {view === 'poster' && (
                            <div className="flex-1 bg-dark flex flex-col h-full overflow-hidden">
                                 {/* 传递 goals 给 PosterGenerator */}
                                 <PosterGenerator 
                                     workouts={workouts} 
                                     goals={goals}
                                     visualSettings={visualSettings}
                                     sportConfigs={sportConfigs}
                                     onVisualSettingsChange={setVisualSettings}
                                 />
                            </div>
                        )}

                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>